# マッチングシステム機能追加仕様書

**バージョン:** 2.1  
**最終更新日:** 2026年2月

**アプリ構成の前提**  
本アプリ（Stargazer）は **Tauri 2 デスクトップアプリ**で、完全ローカル運用です。外部API・認証は使用しません。抽選・マッチング結果のエクスポートはCSVダウンロードで行います。マッチングロジックは `desktop/src/features/matching/` 配下に実装されています。

---

## 目次

1. [実装方針](#実装方針)
2. [NGユーザー機能](#1-ngユーザー機能)
3. [要注意人物機能](#2-要注意人物機能)
4. [NG例外設定機能](#3-ng例外設定機能)
5. [マッチングロジック追加](#4-マッチングロジック追加)
6. [ファイル構成案](#5-ファイル構成案)
7. [実装順序の推奨](#6-実装順序の推奨)
8. [実装時の注意事項](#7-実装時の注意事項)

---

## 実装方針

### ⚠️ 絶対遵守事項

- **マッチングロジックは区分コードで完全分離すること**
- **コードが長くなっても問題なし（重複OK）**
- **各ロジックは独立したファイル/関数として実装**
- **リファクタリング依頼があっても中身の精査のみ実施**
- **統合・共通化の指示があった場合は必ず確認を求めること**

---

## 1. NGユーザー機能

### 1-1. 設定項目

#### 判定基準（プルダウン選択）

以下の3つから選択：

1. **ユーザー名のみで判定**
2. **アカウントID(X)のみで判定**
3. **ユーザー名 OR アカウントID**（どちらか片方が一致すればNG）

#### マッチング時の挙動（選択式）

以下の2つから選択：

#### 1. 警告モード（新規実装）

- マッチング実行
- 結果画面でNGユーザーをハイライト表示
- ドラッグ&ドロップで別のユーザーと入れ替え可能
- 入れ替え先のキャストについてもNG判定を再実行
- リアルタイムで警告表示を更新

#### 2. 除外モード（既に実装済み）

- マッチングアルゴリズム内部で自動除外
- そのキャストとNGユーザーをマッチングさせない

### 1-2. 警告モードUI仕様（新規実装部分）

#### 結果画面

- NGユーザーが含まれるマッチング結果を黄色/オレンジでハイライト
- 警告アイコン表示
- ツールチップで「このユーザーはキャスト○○のNG対象です」表示

#### ドラッグ&ドロップ機能

1. NGユーザーをドラッグ
2. 別のテーブル/スロットにドロップ
3. 入れ替え実行
4. 入れ替え先のキャストでNG判定を自動実行
5. 新たにNGが発生した場合は再度ハイライト
6. NG解消された場合はハイライト解除

### 1-3. データ構造

```typescript
type NGUserSetting = {
  castId: string;
  ngUsers: Array<{
    username?: string;
    accountId?: string;
  }>;
  judgmentType: 'username' | 'accountId' | 'either';
  matchingBehavior: 'warn' | 'exclude';
}

// 警告モード用の結果データ
type MatchingResult = {
  tableId: string;
  rotationNumber: number;
  userId: string;
  castId: string;
  isNGWarning: boolean; // 警告モード用フラグ
  ngReason?: string; // 警告理由
}
```

---

## 2. 要注意人物機能

### 2-1. 自動登録ロジック

#### 条件

- 複数のキャストが同じユーザーをNGに設定
- 閾値（1名〜）は設定可能
- 閾値以上のキャストがNGに設定したユーザーを自動的に要注意人物として登録

#### ⚠️ 判定条件（厳密）

- **ユーザー名 AND アカウントIDの両方が一致**
- どちらか片方だけが一致しても別人として扱う
- **理由:** NGユーザーは身元を明確に把握する必要があるため

### 2-2. 手動登録

- 管理画面から直接要注意人物として登録可能
- ユーザー名とアカウントIDの両方を必須入力

### 2-3. 応募リスト表示仕様

#### 表示タイミング

- マッチング実行前の応募リスト確認ページ

#### 表示内容

要注意人物が含まれる場合：

- ✓ 警告メッセージ表示
- ✓ 該当行を赤色でマーキング
- ✓ 行の右端に❌ボタンを配置

#### ❌ボタン動作

1. クリック時にポップアップ表示
2. 「このユーザーをリストから削除しますか？」確認
3. 削除を選択した場合、応募リストから除外

### 2-4. 重要な仕様

**⚠️ 要注意人物はマッチングロジックに影響しない**

- あくまで事前警告機能
- マッチング自体は通常通り実行可能
- 排除するかは管理者が手動判断

### 2-5. データ構造

```typescript
type CautionUser = {
  username: string;
  accountId: string; // 必須
  registrationType: 'auto' | 'manual';
  ngCastCount?: number; // 自動登録の場合のみ
  registeredAt: Date;
}

type CautionUserSettings = {
  autoRegisterThreshold: number; // 1〜
  cautionUsers: CautionUser[];
}
```

---

## 3. NG例外設定機能

### 3-1. 目的

#### 問題

- 同名ユーザーが複数存在する場合、無関係なユーザーにも警告が出る

#### 解決

- 特定のユーザーを例外リストに登録
- 応募リストでの警告を抑制

### 3-2. 設定方法

#### 必須項目

- ユーザー名（必須）
- アカウントID（必須）

**⚠️ 両方の入力が必須**

### 3-3. 適用条件

#### 例外判定が有効になる条件

- 抽選データに「ユーザー名」AND「アカウントID」の両方が存在する

#### 理由

- アカウントIDがない場合、同名の別人を区別できないため例外判定不可

### 3-4. 効果範囲

- ✓ 応募リスト確認ページでの警告表示を抑制
- ✗ キャストのNG設定には影響しない

#### 例

- ユーザー「太郎（@taro_fake）」を例外登録
- 応募リスト → 警告が出ない
- キャストAが「太郎」をNGに設定している場合
  - → マッチング時は通常通りNG判定される

### 3-5. 判定フロー

```
応募リストチェック時：

1. ユーザー名で要注意人物を検索
2. 該当者がいた場合
   ├─ 抽選データにアカウントIDがある？
   │  ├─ YES → 例外リストに「ユーザー名+アカウントID」が一致？
   │  │         ├─ YES → 警告を出さない
   │  │         └─ NO → 警告・赤マーキング
   │  └─ NO → 通常通り警告・赤マーキング
   └─ 該当者なし → 何もしない
```

### 3-6. データ構造

```typescript
type NGException = {
  username: string;
  accountId: string; // 必須
  registeredAt: Date;
  note?: string;
}

type NGExceptionSettings = {
  exceptions: NGException[];
}
```

---

## 4. マッチングロジック追加

### 4-1. UI設定

#### プルダウン項目

1. 完全ランダムマッチング
2. 完全ローテーションマッチング
3. 空席込みランダムマッチング
4. 空席込みローテーションマッチング
5. グループマッチング
6. 複数マッチング

#### 共通設定

- ローテーション回数（数値入力）

#### ⚠️ バリデーションチェック（設定時点で実施）

- ユーザー数がグループ数で割り切れない場合 → エラー
- キャスト数がローテーションに足りない場合 → エラー
- 複数マッチングでキャスト数がユニット編成に足りない場合 → エラー

---

## 4-2. ロジック1-4: 既存ロジック（名称変更のみ）

### 1. 完全ランダムマッチング

**旧名称:** 特別営業（ランダム）

- 全ユーザーに必ずキャストを配置
- 空席なし
- ランダムに配置

### 2. 完全ローテーションマッチング

**旧名称:** 特別営業（ローテーション）

- 全ユーザーに必ずキャストを配置
- 空席なし
- 順番に回る

### 3. 空席込みランダムマッチング

**旧名称:** 通常営業（ランダム）

- 空席あり得る
- ランダム配置

### 4. 空席込みローテーションマッチング

**旧名称:** 通常営業（ローテーション）

- 空席あり得る
- 順番に回る

---

## 4-3. ロジック5: グループマッチング（新規実装）

### 設定項目

- グループ数（数値）
- 1グループあたりの人数（数値）
- ローテーション回数（数値）

#### ⚠️ バリデーション

- 総ユーザー数 = グループ数 × 1グループの人数
- 割り切れない場合はエラー表示

### 構造

**テーブル > グループ（細分化）**

#### 例

```
応募者20名 → 5グループ × 4名
各グループは独立したローテーション空間
```

### ローテーション動作

5グループが並行してローテーション：

```
グループA: キャスト1 → キャスト2 → キャスト3
グループB: キャスト4 → キャスト5 → キャスト1 （同時進行）
グループC: キャスト2 → キャスト3 → キャスト4
グループD: キャスト5 → キャスト1 → キャスト2
グループE: キャスト3 → キャスト4 → キャスト5
```

### 希望キャスト機能との連携

**⚠️ 既存機能を利用**

- 取り込みファイルに希望キャストの設定があれば名前で判定（既に実装済み）
- グループマッチングでも同じコンポーネントを使用可能
- 別実装でも可

### 配置ロジック（優先順位）

優先順位を必ず守ること：

#### 1. NGユーザー有無を最優先チェック

- キャストのNGユーザーがいるグループには配置しない
- 除外モードの場合: アルゴリズム内部で自動排除（実装済み）
- 警告モードの場合: マッチング後にハイライト表示

#### 2. 希望数による重み付け

- グループ内で「そのキャストを希望するユーザー数」をカウント
- 希望者が多いグループに優先的に配置

#### 3. 希望キャスト設定がある場合

- 希望するキャストをそのグループに配置
- 既存の希望キャスト判定ロジックを使用

### 全グループにNGユーザーがいて配置不可能な場合

#### 対応方法（ユーザーが選択）

**1. ドラッグ&ドロップで手動調整**

- 結果画面でユーザーを移動
- グループ構成を変更してNG回避

**2. NGユーザー単体で再抽選**

- 該当NGユーザーのみを別枠で再マッチング
- 他のユーザーの配置は維持

**⚠️ どちらを使用するかは管理者が選択**

### フローチャート

```
1. グループ分け（応募者をグループに振り分け）
2. 各キャストについて：
   a. 全グループをチェック
   b. NGユーザーがいるグループを除外（除外モードの場合）
   c. 残りのグループで希望数をカウント
   d. 希望数が最も多いグループに配置
3. ローテーション開始位置を決定
4. ローテーション実行
5. 配置不可能なキャストがある場合 → エラー通知 → 対応方法選択
```

### データ構造

```typescript
type GroupMatchingSettings = {
  groupCount: number;
  usersPerGroup: number;
  rotationCount: number;
}

type Group = {
  groupId: number;
  users: User[];
  castRotation: Cast[]; // このグループのキャストローテーション順
}
```

---

## 4-4. ロジック6: 複数マッチング（新規実装）

### 設定項目

- 1テーブルあたりのユーザー数（数値）
- 1ローテあたりのキャスト数（数値）
- ローテーション回数（数値）

#### ⚠️ バリデーション

- キャスト総数 ÷ 1ローテのキャスト数 = 整数
- 割り切れない場合はエラー表示
- ユーザー総数 ÷ 1テーブルのユーザー数 = 整数
- 割り切れない場合はエラー表示

### テーブル数の決定

**自動計算:**

```
テーブル数 = 総ユーザー数 ÷ 1テーブルのユーザー数
```

### 構造

- **ユーザー:** テーブルに固定（着席）
- **キャスト:** 複数名セットで巡回

### 動作イメージ

設定例: 3ユーザー × 2キャスト

```
テーブル1（ユーザーA, B, C）:
  1ローテ → キャスト①&② 接客
  2ローテ → キャスト③&④ 接客
  3ローテ → キャスト⑤&⑥ 接客

テーブル2（ユーザーD, E, F）:
  1ローテ → キャスト③&④ 接客
  2ローテ → キャスト⑤&⑥ 接客
  3ローテ → キャスト①&② 接客
```

### キャストユニットの編成

**⚠️ 固定パターン:**

- 最初に決めたユニットでローテーション全体を回る
- 途中でユニットの組み替えは行わない

#### 例

キャスト6名、2名ずつのユニット

```
ユニットA: [キャスト①②]
ユニットB: [キャスト③④]
ユニットC: [キャスト⑤⑥]

→ この3ユニットが各テーブルを順番に巡回
```

### 配置ロジック

#### 重み付け

- テーブル内の各キャストへの希望数をカウント
- キャストユニットごとにスコアリング
  - ユニット内の全キャストの希望数を合算
  - スコアが高いユニットを優先的に配置

#### 例

```
テーブル1でキャスト①を希望するユーザーが2名、キャスト②を希望するユーザーが1名
→ ユニットA（①②）のスコア = 3
→ 他のユニットより優先的にテーブル1に配置
```

### フローチャート

```
1. ユーザーをテーブルに振り分け
2. キャストをユニット化（設定人数ごとに固定編成）
3. 各テーブルについて：
   a. テーブル内のユーザーの希望をカウント
   b. キャストユニットごとにスコアリング
   c. スコアが高い順にローテーション順を決定
4. NGユーザーチェック（除外モード: 自動排除、警告モード: ハイライト）
5. ローテーション実行
```

### データ構造

```typescript
type MultipleMatchingSettings = {
  usersPerTable: number;
  castsPerRotation: number;
  rotationCount: number;
}

type Table = {
  tableId: number;
  users: User[];
  castUnitRotation: CastUnit[]; // キャストユニットのローテーション順
}

type CastUnit = {
  unitId: string;
  casts: Cast[]; // 複数キャストのセット（固定）
}
```

---

## 5. ファイル構成案（現行実装）

```
desktop/src/
  layout/
    AppContainer.tsx              # ルーティング・サイドバー
  features/
    matching/
      MatchingPage.tsx            # マッチング結果画面
      logics/
        matching_service.ts       # エントリ・振り分け
        matching-result-types.ts  # 型定義
        complete-random.ts        # M001
        complete-rotation.ts       # M002
        vacant-random.ts          # M003
        vacant-rotation.ts        # M004
        group-matching.ts         # M005
        multiple-matching.ts      # M006
        ng-judgment.ts            # NG判定
        caution-user.ts           # 要注意人物
      types/
        matching-type-codes.ts
        matching-system-types.ts
      stores/
        matching-settings-store.ts # NG設定・要注意・NG例外の永続化
    lottery/                       # 抽選条件・抽選結果
    db/                            # DBデータ確認
    cast/                          # キャスト管理
    ng-user/                       # NGユーザー管理
    guide/                         # ガイド
    settings/                      # 設定
    import/                         # データ読取
  common/                          # 型・定数・downloadCsv 等
  components/                      # DiscordTable, ConfirmModal 等
  stores/
    AppContext.tsx                # グローバル状態・Repository
```

---

## 6. 実装順序の推奨

### Phase 1: NGユーザー基盤

1. NGユーザー設定機能（除外モードは実装済み、警告モードを追加）
2. 警告モード結果画面UI（ハイライト＋ドラッグ&ドロップ）
3. 要注意人物機能（自動登録＋手動登録）
4. NG例外設定機能
5. 応募リスト画面のUI実装

### Phase 2: マッチングロジック

6. 既存ロジックの名称変更（1-4）
7. バリデーション機能の実装
8. グループマッチング（5）
9. 複数マッチング（6）

### Phase 3: 統合テスト

10. 各機能の結合テスト
11. エッジケースの検証
12. パフォーマンステスト

---

## 7. 実装時の注意事項

### NGユーザー判定

- 要注意人物の判定: ユーザー名 AND アカウントIDの両方一致（厳密）
- 判定基準によって比較方法を変える
- 大文字小文字の扱いを統一
- 空白文字のトリム処理

### 警告モード

- ドラッグ&ドロップ後のNG再判定を忘れずに
- リアルタイムでハイライト更新
- パフォーマンス考慮（大量データでも快適に動作）

### バリデーション

- 設定画面でリアルタイムバリデーション
- エラーメッセージは具体的に（「グループ数×人数が総ユーザー数と一致しません」等）
- マッチング実行前の最終チェック

### マッチングロジック

**⚠️ 最重要**

- NGユーザーは必ず考慮（全ロジック共通）
- 各ロジックは完全に独立させる
- 共通処理の誘惑に負けない
- 希望キャスト機能は既存実装を活用

### パフォーマンス

- 大量データ（100名以上）での動作確認
- ローテーション計算の最適化
- UI応答性の確保（特にドラッグ&ドロップ）

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|---------|------|---------|
| 2.0 | 2026-02-13 | 初版作成 |
| 2.1 | 2026-02 | アプリ構成の前提（Tauri・完全ローカル）を追記。ファイル構成案を現行の features/matching 構成に更新。 |

---

**このドキュメントについて質問や不明点がある場合は、実装前に必ず確認してください。**
