# セキュリティ対策について

## 店長への事前連絡_セキュリティについて

このアプリケーション（chocomelapp）では、お客様の個人情報や抽選結果などの重要なデータを扱うため、セキュリティ対策を実施しています。

**基本的には、いつも通り使っていただくだけで問題ありません。** ただし、以下の点だけご確認いただけると安心です。

### 知っておいていただきたいこと

1. **エラーメッセージについて**
   - エラーが発生した場合、「エラーが発生しました」などのシンプルなメッセージが表示されます
   - これは、悪意のある人に情報を漏らさないための対策です
   - 詳細な原因はシステム側で記録されているため、問題が続く場合はお問い合わせください

2. **URLの入力について**
   - GoogleスプレッドシートのURLは、そのままコピー&ペーストしてください
   - 手動で入力すると、形式が正しくない場合にエラーになることがあります
   - URLは `https://docs.google.com/spreadsheets/d/...` で始まる形式です

3. **データのサイズについて**
   - 1回のエクスポートで、最大10,000件まで対応しています
   - 通常の運用では問題ありませんが、非常に大量のデータの場合は分割が必要になる場合があります

4. **シート名について**
   - 自動で作成されるシート名（例：`抽選結果_20250210_123456`）は問題ありません
   - 手動でシート名を変更する場合は、特殊な記号（`[` `]` `\` `/` `?` `*` `:` など）は使えません

5. **Googleスプレッドシートの共有設定について（重要）**
   - このアプリケーションは、Googleスプレッドシートのデータを読み書きするために、**サービスアカウント**という専用のアカウントを使用します
   - サービスアカウントのメールアドレス（例：`chocomelapp@xxx.iam.gserviceaccount.com`）を、使用するスプレッドシートの共有設定に追加する必要があります
   - **これは正常な動作です。** Googleが提供する正式な仕組みで、多くのアプリケーションで使用されています
   - サービスアカウントは、あなたの個人アカウントとは別の、アプリケーション専用のアカウントです
   - 共有設定で「編集者」または「閲覧者」の権限を付与してください（データを書き込む場合は「編集者」が必要です）
   - この設定は、初回のみ必要です。一度設定すれば、そのスプレッドシートは継続して使用できます

### もしエラーが発生したら

1. ブラウザの画面に表示されるメッセージを確認してください
2. 同じ操作を再度試してみてください
3. それでも解決しない場合は、エラーメッセージの内容を控えてお問い合わせください

---

## セキュリティ対応策概要

### 1. 認証・ログイン保護

**対策内容：**
- パスワードによるログイン機能を実装
- ログイン後、1週間は自動的にログイン状態を維持
- ログアウトすると、すべてのデータがクリアされます

**店長への影響：**
- パスワードは安全に管理してください
- 共有PCで使用する場合は、必ずログアウトしてください

### 2. データ入力の検証

**対策内容：**
- スプレッドシートのURLやIDの形式を自動的にチェック
- 不正な形式のデータは受け付けません
- データのサイズに上限を設定（DoS攻撃対策）

**店長への影響：**
- 正しいURLを入力していれば、特に意識する必要はありません
- URLはコピー&ペーストで入力することをおすすめします

### 3. エラーメッセージの保護

**対策内容：**
- エラーが発生した場合、詳細な情報を画面に表示しません
- これは、システムの内部情報を悪意のある人に知られないようにするためです
- 詳細なエラー情報は、システム側のログにのみ記録されます

**店長への影響：**
- エラーメッセージがシンプルになりますが、これは正常な動作です
- 問題が続く場合は、エラーメッセージの内容を控えてお問い合わせください

### 4. シート名の検証

**対策内容：**
- シート名に危険な文字が含まれていないか自動的にチェック
- シート名の長さに上限を設定（最大100文字）

**店長への影響：**
- 自動で作成されるシート名は問題ありません
- 手動でシート名を変更する場合のみ、特殊な記号は使えません

### 5. データの保護

**対策内容：**
- ログアウト時に、すべてのデータをメモリから削除
- ブラウザのタブを閉じても、データは保持されますが、ログアウトすると消えます

**店長への影響：**
- ログアウトする前に、必要なデータはスプレッドシートにエクスポートしてください
- 共有PCで使用する場合は、必ずログアウトしてください

### 6. ログイン情報の保護（Cookie設定）

**対策内容：**
- ログイン状態は、**HttpOnly Cookie**という特殊な形式で保存されます
- このCookieは、JavaScriptからアクセスできないため、悪意のあるスクリプトから保護されます
- 本番環境では、HTTPS通信のみでCookieを送信します（Secure属性）
- 他のサイトからの不正なアクセスを防ぐため、SameSite属性を設定しています

**店長への影響：**
- 特に意識する必要はありませんが、ログイン情報が安全に保護されていることを知っておいてください
- 共有PCで使用する場合は、必ずログアウトしてください

### 7. APIアクセスの制限

**対策内容：**
- すべてのAPI（データの読み書きなど）は、ログインしている場合のみアクセス可能です
- ログインしていない状態でAPIにアクセスしようとすると、自動的に拒否されます
- ログインAPIと認証チェックAPI以外は、すべて認証が必要です

**店長への影響：**
- ログインしていないと、データの読み書きができません
- これは正常な動作です。セキュリティを守るための仕組みです

### 8. 入力値の検証と保護

**対策内容：**
- すべての入力値（URL、パスワード、データなど）の形式を厳密にチェックします
- 不正な形式のデータは、処理される前に拒否されます
- パスワード入力時は、タイミング攻撃（入力時間の差からパスワードを推測する攻撃）への対策を実施しています

**店長への影響：**
- 正しい形式のデータを入力していれば、特に意識する必要はありません
- エラーが表示された場合は、入力内容を確認してください

### 9. HTTPS通信の強制（本番環境）

**対策内容：**
- 本番環境では、すべての通信がHTTPS（暗号化された通信）で行われます
- ログイン情報やデータは、暗号化されて送信されるため、途中で盗み見られることはありません

**店長への影響：**
- 特に意識する必要はありませんが、通信が安全に保護されていることを知っておいてください
- ブラウザのアドレスバーに「🔒」マークが表示されていることを確認してください

---

## よくある質問

### Q: エラーメッセージがわかりにくいのですが？

A: セキュリティ上の理由で、詳細なエラーメッセージは表示していません。問題が続く場合は、エラーメッセージの内容を控えてお問い合わせください。

### Q: URLを入力してもエラーになります

A: GoogleスプレッドシートのURLを、そのままコピー&ペーストしてください。手動で入力すると、形式が正しくない場合があります。

### Q: データが消えてしまいました

A: ログアウトすると、メモリ内のデータは消えます。必要なデータは、スプレッドシートにエクスポートして保存してください。

### Q: パスワードを忘れました

A: パスワードは環境変数で管理されています。パスワードを忘れた場合は、システム管理者にお問い合わせください。

### Q: サービスアカウントのメールアドレスをシートに追加するのは安全ですか？

A: **はい、安全です。** サービスアカウントは、Googleが提供する正式な仕組みで、多くのアプリケーションで使用されています。これは、アプリケーションがスプレッドシートにアクセスするために必要な設定です。個人のGoogleアカウントとは別の、アプリケーション専用のアカウントなので、あなたの個人情報が漏れることはありません。

### Q: サービスアカウントにどのような権限を付与すればいいですか？

A: データを読み込むだけの場合は「閲覧者」、データを書き込む（エクスポートする）場合は「編集者」の権限を付与してください。このアプリケーションでは、エクスポート機能があるため、「編集者」の権限を推奨します。

### Q: ログイン情報はどこに保存されますか？

A: ログイン状態は、ブラウザのCookieに保存されます。ただし、HttpOnly属性が設定されているため、JavaScriptからアクセスできず、悪意のあるスクリプトから保護されています。また、本番環境ではHTTPS通信のみで送信されるため、通信途中で盗み見られることもありません。

---

## まとめ

- **基本的には、いつも通り使っていただくだけで問題ありません**
- **Googleスプレッドシートの共有設定に、サービスアカウントのメールアドレスを追加してください**（初回のみ必要）
- URLはコピー&ペーストで入力してください
- エラーメッセージがシンプルなのは、セキュリティ対策のためです
- ログイン情報やデータは、複数のセキュリティ対策で保護されています
- 問題が続く場合は、エラーメッセージの内容を控えてお問い合わせください

---

## 補足：システム的なセキュリティ対策の詳細

このアプリケーションでは、以下のようなシステム的なセキュリティ対策を実施しています：

1. **認証トークンの保護**
   - ログイン状態はHttpOnly Cookieで管理され、JavaScriptからアクセス不可
   - Secure属性により、本番環境ではHTTPS通信のみで送信
   - SameSite属性により、他のサイトからの不正なアクセスを防止

2. **APIアクセス制限**
   - すべてのAPIは、認証済みユーザーのみアクセス可能
   - 未認証のアクセスは自動的に拒否

3. **入力値の検証**
   - URL、ID、シート名などの形式を厳密にチェック
   - 不正な形式のデータは処理前に拒否
   - データサイズに上限を設定（DoS攻撃対策）

4. **エラーメッセージの保護**
   - 詳細なエラー情報をクライアントに返さない（情報漏洩防止）
   - エラーの詳細はサーバー側のログにのみ記録

5. **タイミング攻撃対策**
   - パスワード比較時に、タイミング攻撃への対策を実施

6. **HTTPS通信の強制**
   - 本番環境では、すべての通信がHTTPSで暗号化

これらの対策により、お客様の個人情報や重要なデータが安全に保護されています。
