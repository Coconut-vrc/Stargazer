チャットについてはトークンの消費を抑えるため、必要最低減の出力とする。
どんな機能が追加されたかは自分が操作して確かめるため、説明不要。



これ以降は上記を踏まえた上での要望。
## 機能改善について
確定当選がいる可能性があるため、抽選条件時に応募データから確定枠を追加できるようにする。
ガイドタブを設定の下に移動。
キャスト・ユーザー管理タブはキャスト管理タブに名称を変更。

#インポート画面の列の割り当てについて
現状以下のようになっている。
ユーザー名
VRCアカウントURL
XID
希望キャスト1
希望キャスト2
希望キャスト3
タイムスタンプ
初回フラグ
備考
ペアチケット

が、以下のように変更する。
指定表示項目
・ユーザー名
・アカウントID(X)
・希望キャスト(＋ボタンで列を追加可能)

希望キャストは+ボタンで列を追加可能。(1~5列まで)
希望キャストについては1~5まで、指定された分の列を表示する。
(希望キャスト1,希望キャスト2が指定された場合は希望キャスト3,希望キャスト4,希望キャスト5は表示しない。)
(希望キャスト1,希望キャスト2,希望キャスト3,希望キャスト4が指定された場合は希望キャスト5は表示しない。)

そのほかのインポートされたデータはインポート時に表示するかしないかを選べるものとし、
表示するを選んだ場合はインポート設定画面で表示するカラムを選択できるものとする。  

表示するを選んだ場合は。指定表示項目の右隣に順晩に表示するものとする。
ただし、一画面に収める列は
ユーザー名、アカウントID(X)、希望キャスト1、希望キャスト2、希望キャスト3までとする。
希望キャスト4、希望キャスト5,が指定された場合はスクロール形式で表示する。
他の列を表示する場合もスクロール形式で表示する。


列数が足りない行があります
というエラーチェックは一時的に削除。

#初回フォルダ作成
初回起動時に

＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
C:\Users\ユーザー名\AppData\Localに管理用フォルダを作成します。
C:\Users\ユーザー名\AppData\Local\CosmoArtsStore\Stargazer

よろしいですか？
＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝

というモーダルを出し、ユーザーがOKを押下したら作成する。

次回起動時以降は起動時に毎回確認し、すべてのファイルが存在していないい場合を除き、消えている分は自動で作成する。
C:\Users\ユーザー名\AppData\Local\CosmoArtsStore\Stargazer\cast
の中身が存在しない場合は空のcast.jsonを作成する。

＝＝＝＝＝＝＝＝＝＝CosmoArtsStore\Stargazer内のデータについて＝＝＝＝＝＝＝＝＝＝
C:\Users\ユーザー名\AppData\Local\CosmoArtsStore\Stargazer\src
インポートされたデータの全量を一時的に格納する。
ここのデータをソースとし、DBデータ表示以降の操作を行う。
要注意人物が削除されたりなどがあった場合はその列を削除する場合に限り、加工を許可する。
それ以外は読み取り専用とする。

C:\Users\ユーザー名\AppData\Local\CosmoArtsStore\Stargazer\backup\lottery
抽選するボタンを押下し、抽選結果が表示されたら、自動的にバックアップをとる。
形式は「lottery_YYYYMMDD_HHMMSS.tsv」とする。
出力時はUTF-8(BOMなし)で出力する。

C:\Users\ユーザー名\AppData\Local\CosmoArtsStore\Stargazer\backup\matching
マッチングするボタンを押下し、マッチング結果が表示されたら、自動的にバックアップをとる。
形式は「matching_YYYYMMDD_HHMMSS.tsv」とする。
出力時はUTF-8(BOMなし)で出力する。

C:\Users\ユーザー名\AppData\Local\CosmoArtsStore\Stargazer\cast
キャスト読込についてのデータを格納する。
詳細は「キャスト読込について」を参照。
＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝

#キャスト読込について
キャスト読込は
C:\Users\ユーザー名\AppData\Local\CosmoArtsStore\Stargazer\cast\cast.json
から行う。
キャスト管理ではそこからデータを扱う。

データの形式は
{
  "casts": [
    {
      "name": "こなちゃ",
      "is_attend": false,
      "ng_usersname": [テスト,テスト2,,,テスト5],
      "ng_usersid": [@test,@test2,@test3,@test4,@test5],
      "url": ["https://x.com/aaaa","https://x.com/bbbb"],
      
    },
    {
      "name": "あすた",
      "is_attend": true,
      "ng_username": [テスト,テスト2,,,テスト5],
      "ng_userid": [@test,@test2,@test3,@test4,@test5],
      "url": ["https://x.com/aaaa","https://.com/bbbb"],
    }
  ]
}

のような形とする

＝＝＝＝＝＝＝＝各説明＝＝＝＝＝＝＝＝＝
"name"
キャスト管理ページで表示する各キャストの表示名

"is_attend"
キャスト管理ページで切り替える出席/欠席フラグ

"ng_username"
NGユーザー管理で設定できるNGユーザーのユーザー名(任意追加)

"ng_userid"
NGユーザー管理で設定できるNGユーザーのアカウントID(@から始まる)
マッチングロジックでも@を含むキーワード「@xxx」の形で照合

"url"
キャスト管理ページで入力するキャストのURL。複数導入可能

＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝


#キャスト管理ページについて
キャスト名は変更可能なものとする。ただし、重複不可とする。

キャスト管理のURLは自由入力形式。
+ボタンでURL入力欄を追加可能。
ただし、
https://x.com/Coconut_vrc
https://Twitter.com/Coconut_vrc
のURLはxの黒いアイコンを表示する。
https://x.com/i/chat/1234567890
のURLはxの白いアイコンを表示する。

https://discord.com/channels/~~~~
とあった場合はdiscordのアイコンを表示する。
discordのアイコンはダウンロードする事。

簡易的なキャスト検索機能を導入する
リアルタイムで入力内容に部分一致するキャストをキャスト一覧内で表示する。

#設定ページについて
削除する。
テーマは横のタブでトグル形式で切り替えるものとする。

#機能の削除
応募データリセットボタンは削除する

#ファイル形式
csvファイルからtsvファイルを扱う方針に変更。
全てのcsvを扱っているものはすべてtsvに変更する。

#抽選結果のtsv出力について
出力時はUTF-8(BOMなし)で出力する。
「抽選結果をCSVでダウンロード」ボタンを押下したとき、モーダルを出して、ファイル名を入力できるようにする。
ファイル名はデフォルトでは「抽選結果_YYYYMMDD.tsv」とする。

#マッチング結果のtsv出力について
出力時はUTF-8(BOMなし)で出力する。
「マッチング結果をCSVでダウンロード」ボタンを押下したとき、モーダルを出して、ファイル名を入力できるようにする。
ファイル名はデフォルトでは「マッチング結果_YYYYMMDD.tsv」とする。

#マッチング結果について
マッチング結果については表示結果メンバー内で再割り当て可能とする。
ただし、以下を入れ替え時毎回チェックすること。
・1ユーザーにつき同じキャストが2回以上担当にならないか
・キャストとキャストのNGユーザーがマッチングしないか
・おなじローテーションにキャストが重複しないか
以上を検知した場合は、オレンジで警告色を出す。
※ 警告色はオレンジに変更済み。再割り当て用ドロップダウンUIは別途対応可。

#NGユーザー登録について
NGユーザー削除については「キャスト別 NG一覧」で行えるようにする。
xxx のNGユーザー一覧（〇名）
の部分は廃止する。
※ 対応済み：キャスト別NG一覧で削除可能、xxxのNG一覧（〇名）は廃止。


#条件について
@matching-type-codes.ts (15-22) 
は以下とする。他に関連する部分も修正する。

export const MATCHING_TYPE_LABELS: Record<MatchingTypeCode, string> = {
  M000: 'マッチングは使用しない',
  M001: 'ランダムマッチング',
  M002: 'ローテーションマッチング',
  M003: '複数名マッチング',
};


#文言についt
インポート画面の文言を修正する。
「ユーザー名・VRCアカウントID・アカウントID(X)のいずれかは必ず列を指定してください。」
→「アカウントID(X)は必ず指定してください。」

# 複数マッチングについて
複数マッチングはローテーション形式のみ対応とする。
おなじローテーション、おなじ当選者にキャストが重複しないこと。
また、マッチング結果には総数で表示すること
3対２の場合、1枠には
3名の当選者と2名のキャストが表示される。

##抽選結果画面について
当選者がNGユーザーとして設定されていた場合、枠外にNGキャストを表示ボタンを配置し、誰がNGかを参照できるようにする。




M003 複数マッチング: ロジック修正と表示改修

現状の問題

1. 同ローテでキャストが複数テーブルに重複配置される (ロジックバグ)

multiple-matching.ts の対角配置式:

unitIdx = (chosenOffset + t + r) % unitCount

tableCount > unitCount のとき、同じローテーション内で同じユニットが複数テーブルに割り当てられる。例: unitCount=3, tableCount=5 ではテーブル0とテーブル3が同じユニットを参照する。

2. テーブル単位のグルーピングがない (表示バグ)

MatchingPage.tsx L146:

tableSlots.map((slot, i) => ({ tableIndex: i + 1, ... }))

M003 では1テーブルに複数ユーザーが座るが、tableIndex: i + 1 で全スロットに別のテーブル番号が振られてしまう。同テーブルのユーザーが別テーブルとして表示される。

3. castsPerRotation > 1 のとき表示がずれる (表示バグ)

matches配列は ROUNDS * castsPerRotation 個のエントリを持つが、表示コード row.matches[roundIdx] は1ローテ1キャスト前提。castsPerRotation=2だとローテ2のキャストがローテ1の2人目として表示される。

4. キャスト別ビューが1ローテ1ユーザーしか保持できない

CastViewRow.perRound が (CastAssignment | null)[] のため、usersPerTable > 1 で同ローテに複数ユーザーがいるケースに対応できない。



修正方針

A. matching-result-types.ts — TableSlot に tableIndex 追加

export interface TableSlot {
  user: UserBean | null;
  matches: MatchedCast[];
  tableIndex?: number; // M003用: 1-based テーブル番号
}

B. multiple-matching.ts — ロジック修正





バリデーション追加: unitCount < tableCount のときエラーメッセージ付きで空結果を返す（1体のキャストが2テーブル同時は不可能）



tableIndex 付与: 各 TableSlot に正しいテーブル番号 (1-based) を設定



matches 配列のレイアウトを明文化: matches[r * castsPerRotation + c] = ローテーション r のキャスト c

C. MatchingPage.tsx — テーブルグルーピング表示

M003 のときの表示を以下の構造に変更:

テーブル 1
  user1 @x1  | 柘榴_ざくろ 第1希望 | ヌウア 希望外    |
  user2 @x2  | 柘榴_ざくろ 第3希望 | ヌウア 第1希望  |
─────────────────────────────────────────
テーブル 2
  user3 @x3  | moku 第2希望       | なゆたの 第1希望 |
  user4 @x4  | moku 希望外        | なゆたの 第2希望 |

具体的な変更:





MatchingRow に isFirstInTable フラグを追加。最初のユーザー行にのみテーブル番号を表示



同テーブルのユーザー間にはセパレーターなし、テーブル間にはCSS区切り線を追加



ローテーション列: castsPerRotation > 1 のときは matches[roundIdx * castsPerRotation] から castsPerRotation 個を取得してすべてのキャスト名とランクバッジを表示

D. キャスト別ビュー修正

CastViewRow.perRound を (CastAssignment | null)[] から CastAssignment[][] に変更し、1ローテーション内の複数ユーザーを保持可能にする。usersPerTable > 1 で全ユーザーが表示される。

E. TSVエクスポート / バックアップ修正

M003のTSVエクスポートも同様に:





テーブル番号を正しく出力



castsPerRotation > 1 のとき全キャストを出力



変更ファイル一覧





matching-result-types.ts — tableIndex 追加



multiple-matching.ts — バリデーション、tableIndex付与、重複防止



MatchingPage.tsx — グルーピング表示、複数キャスト/ユーザー対応、エクスポート修正

