# アプリケーション仕様書

**文書の目的**  
本仕様書は、抽選・マッチング管理アプリの機能・画面・データ形式を定義したものです。  
**見積書**（みつもりしょ）や発注書とあわせて、開発範囲と受託条件の共通認識としてご利用ください。

---

## 1. 概要

| 項目 | 内容 |
|------|------|
| アプリ名 | chocomelapp（任意で変更可能） |
| 種別 | Webアプリケーション（管理画面） |
| 目的 | イベント等の応募者抽選・キャストマッチング・結果のスプレッドシート連携を一括で行う |
| 利用者 | 運営側（管理者）のみ。パスワード認証で保護 |
| 技術 | Next.js（App Router）, React, TypeScript, Google Sheets API |

**開発環境・作成経緯**  
本アプリは **Cursor**（AI 支援付きコードエディタ）を用いて、仕様に基づき**ほぼすべての実装**（設計・コーディング・リファクタ・テスト）が行われています。第三者による再確認・見積もり時は、この点を前提としてご参照ください。

---

## 3. 画面一覧

| No. | 画面名 | パス/ID | 説明 | 認証 |
|-----|--------|---------|------|------|
| 1 | ログイン | LOGIN | パスワード認証 | 不要 |
| 2 | ガイド | GUIDE | 使い方・FAQ | 要 |
| 3 | データ読取 | IMPORT | スプレッドシートURL設定・同期・既存結果取り込み | 要 |
| 4 | DBデータ確認 | DB | 応募者名簿一覧表示 | 要 |
| 5 | 抽選条件 | LOTTERY_CONDITION | 営業モード・当選者数・総テーブル数・マッチング方式の設定と抽選実行 | 要 |
| 6 | 抽選結果 | LOTTERY | 当選者一覧・シート保存・マッチングへ | 要 |
| 7 | マッチング結果 | MATCHING | 当選者別/テーブル別・キャスト別の表示とシート/PNG出力 | 要 |
| 8 | キャスト管理 | CAST | キャスト追加・出席/欠席・NGユーザー・シート同期 | 要 |

---

## 4. 画面別詳細仕様

### 4.1 ログイン（LOGIN）

- **機能**: パスワード入力による認証。成功時はCookieでセッション維持（例: 1週間）。
- **入力**: パスワード（必須）。
- **遷移**: 成功時はデータ読取または前回表示ページへ。
- **備考**: パスワードは環境変数で管理。ログアウトでCookie削除。

---

### 4.2 ガイド（GUIDE）

- **機能**: アプリの使い方フロー・データ読取〜マッチングまでの手順・FAQ・用語説明。
- **表示**: 静的コンテンツ＋サンプルプレビュー（テーブル見本など）。

---

### 4.3 データ読取（IMPORT）

- **機能**
  - 営業モード選択: **特別営業**（完全事前抽選制） / **通常営業**。
  - 応募者名簿URL・キャストリストURLの入力と保存（localStorageに前回1件を保持）。
  - 「保存して同期を開始」でスプレッドシートからデータ取得し、メモリとRepositoryに格納（永続化はセッション内のみ。リロードで消失）。
  - 同一ブック内に既存の抽選結果シートがある場合はモーダルでシート選択・マッチング方式選択の上、取り込み可能。
- **入力**
  - 営業モード（必須）
  - 応募者名簿 URL（必須）
  - キャストリスト URL（必須）
- **制約**
  - 応募者名簿は営業モードに応じた列数（通常7列・特別9列）。不足時はエラーモーダルで通知。
- **遷移**: 同期成功後はDBデータ確認へ（既存結果取り込みモーダルはその前に表示）。

---

### 4.4 DBデータ確認（DB）

- **機能**: 読み込んだ応募者名簿の一覧表示。名前・X ID・希望1〜3・意気込み等。
- **操作**: X IDクリックで外部リンク確認後、Xのユーザーページを開く。「抽選条件へ」で抽選条件画面へ。

---

### 4.5 抽選条件（LOTTERY_CONDITION）

- **機能**
  - 営業モード: 特別営業 / 通常営業。
  - 当選者数（必須）。特別営業時は出席キャスト数と一致が推奨。
  - 総テーブル数: **通常営業時のみ**。当選者数以上。空テーブル含む総数。
  - マッチング方式: ランダムマッチング（希望優先） / 循環方式マッチング（ローテーション）。
  - 「抽選を開始する」でランダム抽選を実行し、当選者を決定。通常営業時は総テーブル数をContextに保存（マッチングで使用）。
- **入力**
  - 営業モード（必須）
  - 当選者数（必須、1以上、出席キャスト数以下）
  - 総テーブル数（通常営業時必須、当選者数以上）
  - マッチング方式（必須）
- **バリデーション**: 当選者数＞出席キャスト数、通常時で総テーブル数＜当選者数はエラー。出席者数と一致しない場合は確認モーダルで実行可否を選択。

---

### 4.6 抽選結果（LOTTERY）

- **機能**: 当選者一覧の表示。抽選結果をスプレッドシートに新規シート（例: `抽選結果_YYYYMMDD_HHMMSS`）として保存。「マッチング開始」でマッチング結果画面へ遷移。

---

### 4.7 マッチング結果（MATCHING）

- **機能**
  - ローテーション数: 通常営業3ローテ・特別営業2ローテ。
  - **通常営業で総テーブル数が設定されている場合**: テーブル別表示（空テーブル含む）。当選者希望をなるべく叶えつつ、総テーブル数に合わせてローテーション配置。
  - **上記以外**: 当選者別表示（従来どおり）。
  - キャスト別ビュー: 各キャストが各ローテで担当するユーザー一覧。
  - エクスポート: 同一スプレッドシート内に「テーブル別」または「ユーザー別」＋「キャスト別接客リスト」を新規シートで作成。PNG出力（当選者別/テーブル別・キャスト別）対応。
- **表示項目**: テーブル番号/当選者（または当選ユーザー）、1〜3ローテ目（キャスト名・希望ランク表示）。キャスト別はキャスト名・ローテ別ユーザー・ランク。
- **注意**: 「希望をなるべく叶えつつローテーション配置」は条件が厳しいと**解なし**でエラーになる場合がある。フォールバック（妥協案・希望外の割当を許容する等）の定義をしておくと運用しやすい。

---

### 4.8 キャスト管理（CAST）

- **機能**
  - 出席状況サマリ: 出席者(12) / 欠席者(10) をチップで一覧表示。チップクリックで出席/欠席を切り替え可能。補足文言で「名前をタップ/クリックすると出席・欠席を切り替えられます」を表示。
  - キャスト新規登録: 名前入力で追加。**キャストリストURLが未設定の場合はエラーメッセージを表示し、シートへの書き込みは行わない。** URL設定済みの場合は指定シートの次の行に書き込み（名前・出席0・NG空）。
  - 出席/欠席トグル: カードまたはサマリチップで切り替え。スプレッドシートのB列（出席フラグ）を 1/0 で更新。
  - NGユーザー: 対象キャストを選択し、ユーザー名を追加。C列にカンマ区切りで書き込み。削除時は該当行を空クリア。
  - キャスト削除: 確認モーダル後、該当行を空にしてRepositoryから削除。
- **制約**: キャスト追加のスプレッドシート書き込みには、データ読取で設定した「キャストリスト URL」が必須。書き込み失敗時は「URLと共有設定（編集権限）を確認してください」と表示。

---

## 5. データ仕様

### 5.1 応募者名簿シート（ユーザーシート）

- **通常営業**: 7列（A〜G）
  - A: タイムスタンプ, B: VRC名, C: X ID, D: 当店にご帰宅…, E: 希望キャスト（3人までカンマ区切り）, F: 意気込み, G: その他
- **特別営業**: 9列（A〜I）
  - A〜D: 同上, E: 第一希望, F: 第二希望, G: 第三希望, H: 意気込み, I: その他
- **取得範囲**: A2:I1000（ヘッダー除く）

### 5.2 キャストシート

- **列**: A: キャスト名, B: 出席フラグ（1/0）, C: NGユーザー（カンマ区切り）
- **取得範囲**: A2:C50
- **書き込み**: キャスト追加時は次の空行に A=名前, B=0, C=空。出席変更はB列、NG変更はC列を更新。

### 5.3 自動作成シート名

- 抽選結果: `抽選結果_YYYYMMDD_HHMMSS`
- マッチング結果: `マッチング結果_YYYYMMDD_HHMMSS`

---

## 6. 非機能要件（要約）

- **認証**: パスワード認証。Cookieで一定期間維持。ログアウトでクリア。
- **外部連携**: Google Sheets API（読み取り・書き込み）。credentials または環境変数で認証。
- **データ保持**: 応募者・キャスト等の一覧はメモリ上（リロード後は再同期が必要）。当選者一覧・営業モード・総テーブル数・マッチング方式・最終表示ページ・シートURL等は LocalStorage にセッションとして保存し、**ログイン中の同一端末・同一ブラウザではリロード後も復元可能**。ログアウト時・認証切れ時にはメモリとセッションの両方をクリア。
- **デプロイ**: Next.js のスタンダード出力。Vercel 等でのデプロイを想定。本番デプロイは **main** ブランチを想定。

---

## 7. 実装方式・使用技術

機能ごとに**何を使っているか**を記載します。保守・見積もり・引き継ぎの参考にしてください。

### 7.1 フレームワーク・言語

| 項目 | 使用技術 |
|------|----------|
| フレームワーク | Next.js 16（App Router） |
| UI ライブラリ | React 19 |
| 言語 | TypeScript 5 |
| スタイル | Tailwind CSS 4、カスタム CSS（common.css, layout.css） |
| フォント | next/font（Geist, Geist_Mono） |
| アイコン | lucide-react |

- ルーティングは **SPA 風**：単一ページ（page.tsx）で `AppContainer` を表示し、内部で `activePage` に応じて ImportPage / DBViewPage / LotteryPage / LotteryResultPage / MatchingPage / CastManagementPage / GuidePage を切り替え。Next.js のファイルベースルートは利用せず、認証後はすべてクライアント側で画面切替。

### 7.2 認証

| 項目 | 実装内容 |
|------|----------|
| 方式 | パスワード認証（単一管理者） |
| パスワード保存 | 環境変数 `CHOCOMELAPP_ADMIN_PASSWORD`（サーバー側のみ） |
| セッション | Cookie 名 `admin_auth`、値 `authenticated` |
| Cookie オプション | HttpOnly、本番時は secure、sameSite: lax、有効期限 12 時間 |
| ログイン API | `POST /api/auth/login`（body: `{ password }`）。一致時は上記 Cookie を Set-Cookie で返す。 |
| 認証確認 API | `GET /api/auth/check`（Cookie の有無で success を返す） |
| ログアウト API | `POST /api/auth/logout`（Cookie 削除） |
| アクセス制御 | Next.js **middleware** で `/api/*` へのリクエスト時に Cookie を検証。未認証時は 401。ログイン・チェック API と静的ファイルは除外。 |

- 画面（ページ）へのアクセスは middleware ではブロックせず、`AppContainer` 内で認証状態をチェックし、未ログイン時は LoginPage を表示。

### 7.3 状態管理

| 項目 | 実装内容 |
|------|----------|
| グローバル状態 | React **Context**（`AppContext.tsx`）。Provider は `AppProvider`。 |
| 保持内容 | 表示ページ（activePage）、Repository インスタンス、当選者一覧（currentWinners）、マッチング方式（rotation/random）、営業モード（special/normal）、総テーブル数（totalTables）、テーマ（dark/shokomel） |
| データ格納 | **Repository** クラス（同一ファイル内）。応募者リスト（UserBean[]）、キャストリスト（CastBean[]）、応募者名簿 URL・キャストリスト URL をメモリ上で保持。ログアウト時は `resetAll()` でクリア。 |
| 永続化 | **localStorage** で URL 履歴（`STORAGE_KEYS.USER_URL_HISTORY` / `CAST_URL_HISTORY`）と軽量なセッション情報（当選者一覧・営業モード・総テーブル数・マッチング方式・最終表示ページ・シートURL 等）を保持。応募者/キャストの一覧そのものは永続化せず、リロード後は再同期が必要。ログアウト / 認証切れ時にクリア。 |

- エンティティ定義は `common/types/entities.ts`（UserBean, CastBean 等）。シート列定義・範囲は `common/sheetColumns.ts`。

### 7.4 Google Sheets 連携

| 項目 | 実装内容 |
|------|----------|
| クライアント | **SheetService**（`infrastructures/googleSheets/sheet_service.ts`）。fetchSheetData / updateSheetData / createSheetAndWriteData / listSheets を提供。 |
| 通信 | いずれも `POST /api/sheets` に JSON（spreadsheetId, range, values, method, sheetName 等）を送信。 |
| サーバー | **googleapis**（Node 用公式ライブラリ）。認証はサービスアカウント（credentials.json または環境変数）を想定。 |
| API の役割 | 読取（range 指定）、範囲更新（UPDATE）、新規シート作成（CREATE_SHEET）、シート一覧取得（LIST_SHEETS）。 |
| バリデーション | spreadsheetId・range・sheetName の形式検証。values は 2 次元配列かつサイズ上限（行 10000・列 1000）で DoS 対策。 |

- URL から spreadsheetId を抽出する正規表現は SheetService 内で実装。不正な URL はエラーで返す。

### 7.5 抽選ロジック

- **実行場所**: クライアント（LotteryPage 等）。サーバーは関与しない。
- **方式**: 応募者リスト（Repository）から、当選者数 N を**ランダム**に選択。`Math.random()` を用いたシャッフルまたはインデックス抽選。
- **前提**: 当選者数は出席キャスト数以下など、画面側のバリデーションで担保。

### 7.6 マッチングロジック

| 項目 | 実装内容 |
|------|----------|
| 実装場所 | `features/matching/logics/matching_service.ts`（**MatchingService** クラス） |
| 入力 | 当選者リスト、キャストリスト、マッチング方式（rotation / random）、ローテーション数、通常営業時は総テーブル数（totalTables） |
| 希望の扱い | ユーザーごとの希望キャスト名リスト（第1〜第3希望）に**重み**を付与（第1希望 100、第2希望 70、第3希望 40、希望外 10）。重み付きランダムで割当。 |
| NG ユーザー | キャストの `ng_users` に含まれるユーザーはそのキャストには割り当てない。 |
| 循環方式（rotation） | テーブル順にキャストがずれていく**ローテーション**。総テーブル数指定時は空テーブルも含めた **tableSlots** を生成。 |
| ランダム方式（random） | 希望優先の重み付きランダム割当。当選者別の **userMap** を返す。 |
| ローテーション数 | 通常営業 3、特別営業 2（`common/copy.ts` の ROTATION_COUNTS）。 |

- 条件が厳しい場合は解なしになり得る。フォールバック（希望外の割当を許容する等）はロジック内で一部対応。

### 7.7 PNG 出力（マッチング結果）

| 項目 | 実装内容 |
|------|----------|
| ライブラリ | **html-to-image**（`toPng`） |
| 流れ | マッチング結果画面内の表示用 DOM ノード（当選者別/テーブル別・キャスト別）を `toPng` で画像化し、Blob からダウンロード用リンクを生成。 |

- クライアントのみで完結。サーバーは関与しない。

### 7.8 その他

- **モーダル**: 確認ダイアログは `components/ConfirmModal.tsx`。ResultImportModal は既存結果取り込み用。
- **テーブル表示**: `components/DiscordTable.tsx`（列定義は DiscordTableColumn）。
- **エラーハンドリング**: `ErrorBoundary.tsx` で React エラーを捕捉。API エラーは各画面でメッセージ表示。

---

## 8. Google Sheets API 制限と利用目安

### 8.1 公式のクォータ（目安）

Google のドキュメントでは、おおよそ次のように定められています（プロジェクト・設定により変動する場合があります）。

| 種類 | プロジェクトあたり | ユーザーあたり |
|------|-------------------|----------------|
| **読み取り** | 300 回/分 | 60 回/分 |
| **書き込み** | 300 回/分 | 60 回/分 |

- 超過すると **429 Too Many Requests** が返り、約1分後に再試行可能。
- **1日あたりの上限**は公式には明示されていませんが、**1分あたり**の制限が主なボトルネックです。

### 8.2 本アプリの API 呼び出し頻度（目安）

| 操作 | 読み取り | 書き込み |
|------|----------|----------|
| データ読取（同期） | 2回（応募者＋キャスト） | 0 |
| 既存結果シート一覧 | +1回（listSheets） | 0 |
| 既存結果の取り込み | +1回（該当シート取得） | 0 |
| キャスト追加 | 0 | 1回 |
| 出席/欠席の切り替え | 0 | 1回/回 |
| NG追加・キャスト削除 | 0 | 1回/回 |
| 抽選結果をシートに保存 | 0 | 2回（シート作成＋書き込み） |
| マッチング結果をシートに保存 | 0 | 2回（同上） |

**1イベントあたりのざっくり目安**（通常の流れ）  
- 同期 1回: 読 2〜4  
- キャストの出席切り替え 20〜40回: 書 20〜40  
- 抽選結果・マッチング結果の保存 各1回: 書 4  
→ **読 2〜4、書 24〜44 程度/1イベント**

### 8.3 5イベントで使う場合

- **時間帯がずれていれば**（例: イベントが別日や別時間）  
  → 1分あたりのリクエストは分散するため、**制限にかかる可能性は低い**です。

- **同じ1分間に5イベント分の操作が集中した場合**  
  - 読: 5 × 4 = 20 → 300/60 に余裕あり。  
  - 書: 5 × 44 = 220 → **プロジェクト 300/分には届かないが、ユーザー 60/分を超える可能性はある**（1人が1分で60回以上書き込むと制限の可能性）。

**注意しやすいケース**  
- キャスト管理で **出席/欠席を短時間に何十回も連打**する。→ レートリミット対策として**連続操作をまとめてから送信**する処理を実装済み（約0.6秒待ってから一括反映）。  
- **同じプロジェクト（同じVercel・同じAPIキー）**で、複数イベントが **同時刻**に一斉に「同期→抽選→保存→マッチング保存」する。

### 8.4 運用の目安

- **5イベントを「別日・別時間」で使う**  
  → 通常運用なら **制限はあまり気にしなくてよい**範囲です。  
- **同日に複数イベントで使う**  
  → 可能なら開始時刻を 10〜15分ずらすと、書き込みが 1分に集中しにくくなります。  
- **429 が出た場合**  
  → 約1分待ってから再操作。必要なら「書き込みは少し間隔を空ける」と案内すると安心です。

**補足**  
- クォータの最新値は [Google Sheets API の使用制限](https://developers.google.com/sheets/api/limits) で確認してください。  
- 同じ GCP プロジェクトを他サービスと共有している場合は、その分だけ余裕を小さく見ておくと安全です。

---

## 9. 制約・既知の課題と今後の検討事項

第三者評価や見積書との整合性を踏まえ、**現状の制約**と**改善の方向性**を補足します。

### 9.1 データ永続性

| 項目 | 現状 | 改善の方向性 |
|------|------|--------------|
| **保持範囲** | 応募者・キャストの一覧はメモリと Context のみ。**当選者一覧・営業モード・総テーブル数・マッチング方式・最終表示ページ・シートURL 等は LocalStorage にセッションとして保存**し、ログイン中の同一端末・同一ブラウザでは復元される。 | 応募者・キャストも含めたスナップショットを **IndexedDB** 等で永続化することで、より完全な「途中再開」を実現できる。 |
| **運用上の前提** | ログイン中かつ同一端末・同一ブラウザであれば、リロード後も抽選結果・設定は復元される。ただし応募者・キャスト一覧はリロード後に再同期が必要。 | 応募者・キャスト一覧も永続化し、途中離脱からそのまま続きやすい運用にすることが将来的な改善ポイント。 |

- シートへの書き込み（抽選結果・マッチング結果）は「保存」操作で永続化されるため、**シート保存済みのデータはリロード後もシートから再取得可能**（既存結果取り込み機能で復元可能）。

### 9.2 Google Sheets API 制限対策

| 項目 | 現状 | 改善の方向性 |
|------|------|--------------|
| **出席・欠席の保存** | 出席/欠席の切り替えは、連続操作を**約0.6秒待ってからまとめてシートに反映**する。反映待ち中は「保存の反映待ちです。このまま画面を離れると…」と表示。 | 実装済み。連打時も API 呼び出し回数を抑えつつ、反映待ち中は注意を表示。 |
| **バッチ処理** | 未実装。複数行の更新も 1 行ずつ API 呼び出し。 | 範囲指定での一括更新（**batchUpdate**）の検討で、呼び出し回数を削減可能。 |

- 8 章の運用目安（別日・別時間での利用、連打を避ける案内）で、現状でも多くの運用は成立する想定。

### 9.3 エラーハンドリング・フォールバック

| 項目 | 現状 | 改善の方向性 |
|------|------|--------------|
| **マッチング「解なし」** | 条件が厳しい場合に解が存在しない可能性あり。仕様上は「フォールバック（妥協案）の定義をしておくと運用しやすい」と記載。 | 試行回数上限の設定、制約緩和後の再試行、**希望外の割当を許容する**などのルールを仕様・実装の両方で具体化するとよい。 |
| **エラーメッセージ** | API 失敗時は「取得に失敗したよ」「更新に失敗したよ」等の文言。 | 原因別（認証エラー・ネットワーク・レートリミット等）のメッセージや、ユーザー向けの対処案を出すと保守性・運用が向上。 |

### 9.4 保守性・拡張性

| 項目 | 現状 | 備考 |
|------|------|------|
| **テストコード** | 単体テスト・E2E テストの有無やカバレッジは**本仕様書の対象外**。実装リポジトリにテストが含まれるかは別途確認。 | 見積・保守契約では「テスト整備」を範囲に含めるかどうかを明示するとよい。 |
| **ドキュメント** | 本仕様書のほか、README・コメント・FUNCTIONAL_SPEC 等がリポジトリに存在する場合あり。 | 保守担当者向けに「どこに何が書いてあるか」を一覧化しておくと引き継ぎがしやすい。 |

- 上記は**仕様の透明性と見積・保守範囲の明確化**のための補足であり、実装の有無や優先度は別途スコープで決める想定です。

---

## 10. 改訂履歴（例）

| 版 | 日付 | 内容 |
|----|------|------|
| 1.0 | （作成日） | 初版。画面一覧・画面別仕様・データ仕様・用語を整備。 |
| 1.1 | （作成日） | Google Sheets API 制限と利用目安（8章）を追加。 |
| 1.2 | （作成日） | 用語に INV/RFQ/SOW を追加。技術的注意（永続性・API・マッチング）を各所に追記。相場・報酬に関する記述を削除（バイアス回避）。 |
| 1.3 | （作成日） | 概要に開発環境・作成経緯（Cursor）を追記。実装方式・使用技術（7章）を追加。 |
| 1.4 | （作成日） | 制約・既知の課題と今後の検討事項（9章）を追加。データ永続性・API制限対策・エラー・フォールバック・テスト・ドキュメントの現状と改善の方向性を補足。 |

---

Q＆A

Q: 開発の対象範囲を教えてください
A: 新規開発（ゼロから構築）

Q: 見積書に含めたい項目を選んでください（該当するものをすべて選択）
A: 開発工数・金額, スケジュール・納期, 保守運用費用, 技術的なリスク事項

Q: Google Sheets API の認証情報は誰が用意しますか？
A: 開発側で用意して納品


**補足**  
- 本仕様書は、**見積書**とあわせて「何を作るか・どこまでが範囲か」を明文化するために利用できます。
- 仕様変更・追加機能は、別途スコープと見積もりで対応する形にすると、範囲の線引きがしやすくなります。
