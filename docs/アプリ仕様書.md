# アプリケーション仕様書（Stargazer）

**文書の目的**  
本仕様書は、抽選・マッチング管理アプリ **Stargazer** の機能・画面・データ形式を定義したものです。  
開発範囲と保守時の共通認識としてご利用ください。

**最終更新:** 2026年2月

---

## 1. 概要

| 項目 | 内容 |
|------|------|
| アプリ名 | Stargazer |
| 種別 | デスクトップアプリケーション（Tauri 2） |
| 目的 | イベント等の応募者抽選・キャストマッチングを**完全ローカル**で行い、結果をCSVで出力する |
| 利用者 | 運営側（管理者）のみ。認証機能はなし（ローカル単体利用を想定） |
| 技術 | Tauri 2, React, TypeScript, Vite |

**開発環境・作成経緯**  
本アプリは **Cursor**（AI 支援付きコードエディタ）を用いて、仕様に基づき実装・リファクタが行われています。

---

## 2. アーキテクチャの特徴

- **完全ローカル**: 外部API・クラウド連携なし。応募データはCSVファイル取り込み、キャスト・NGはPC内のJSONで管理。
- **データ保存先**: `%LOCALAPPDATA%\CosmoArtsStore\` 配下（cast/db.json 等）。Tauri のファイルシステムで読み書き。
- **エクスポート**: 抽選結果・マッチング結果は「CSVでダウンロード」によりブラウザのダウンロードフォルダ等に保存。

---

## 3. 画面一覧

| No. | 画面名 | 画面ID | 説明 |
|-----|--------|--------|------|
| 1 | ガイド | guide | 使い方・FAQ |
| 2 | データ読取 | import | CSVファイルで応募データを取り込み |
| 3 | DBデータ確認 | db | 応募者名簿一覧表示 |
| 4 | 抽選条件 | lotteryCondition | マッチング形式・当選人数等の設定と抽選実行 |
| 5 | 抽選 | lottery | 当選者一覧・CSVダウンロード・マッチングへ |
| 6 | マッチング | matching | 当選者別/テーブル別・キャスト別の表示とCSV/PNG出力 |
| 7 | キャスト管理 | cast | キャスト追加・出席/欠席 |
| 8 | NGユーザー管理 | ngManagement | キャストごとのNGユーザー登録 |
| 9 | 設定 | settings | テーマ・NG判定基準・要注意人物・NG例外 |
| 10 | デバッグ | debug | 開発時のみ。LocalAppData構造・DB表示・簡易SQL風クエリ |

※ ログイン画面はなし（完全ローカル運用のため）。

---

## 4. 画面別詳細仕様

### 4.1 ガイド（guide）

- **機能**: アプリの使い方フロー（データ読取〜マッチングまで）・各画面の説明・マッチング形式（M001〜M006）・FAQ。
- **表示**: 静的コンテンツ＋サンプルプレビュー（テーブル見本など）。copy.ts の GUIDE を参照。

### 4.2 データ読取（import）

- **機能**
  - インポート形式: **基本テンプレート**（列固定） / **カスタム**（列の割り当てを指定）。
  - 「CSVファイルを選択」で応募データCSVを開き、取り込み。Tauri のダイアログ・FS を使用。
  - 取り込み後はメモリと Repository に格納し、DBデータ確認画面へ遷移。
- **入力**: テンプレート選択 or カスタム時の列割り当て（ユーザー名・X ID・希望1〜3 等）。ユーザー名またはアカウントIDのどちらかは必須。
- **制約**: テンプレート時は所定列数以上であること。カスタム時は必須列の指定が必要。

### 4.3 DBデータ確認（db）

- **機能**: 読み込んだ応募者名簿の一覧表示。名前・X ID・希望1〜3・意気込み等。X IDクリックで外部リンク確認後、Xのユーザーページを開く。
- **表示**: DiscordTable による表。要注意人物・NG例外のハイライト表示あり（設定で有効時）。

### 4.4 抽選条件（lotteryCondition）

- **機能**
  - マッチング形式: M001（完全ランダム）〜 M006（複数マッチング）を選択。
  - ローテーション回数・当選人数（または総テーブル数・グループ数等、形式に応じて）を入力。
  - 「抽選を開始する」でランダム抽選を実行し、当選者を決定。抽選画面へ遷移。
- **入力**: マッチング形式（必須）、当選人数ほか形式別パラメータ。
- **バリデーション**: 形式に応じた人数・テーブル数・グループ数の整合性チェック。

### 4.5 抽選（lottery）

- **機能**: 当選者一覧の表示。「抽選結果をCSVでダウンロード」でCSVファイルをダウンロード。「マッチング開始」でマッチング結果画面へ遷移。
- **エクスポート**: ファイル名は `抽選結果_YYYYMMDD_HHMMSS.csv`。BOM付きUTF-8 CSV。

### 4.6 マッチング結果（matching）

- **機能**
  - 当選者別またはテーブル別のマッチング結果表示。キャスト別ビューあり。
  - 「マッチング結果をCSVでダウンロード」でCSVをダウンロード（テーブル別/ユーザー別＋キャスト別接客リストを1ファイルに）。
  - 「PNGで保存（当選者別）」「PNGで保存（キャスト別）」で表示表を画像として保存。
- **表示**: 希望ランクバッジ（第1〜3希望・希望外）。NG警告モード時は該当セルをハイライト。

### 4.7 キャスト管理（cast）

- **機能**
  - 出席状況サマリ: 出席者/欠席者をチップで一覧。チップクリックで出席/欠席を切り替え。
  - キャスト新規登録: 名前入力で追加。Repository と LocalAppData の cast/db.json に保存（Tauri 内）。
  - 外部データ: public/sample-casts.json を読み込んで既存キャストにマージ可能（オプション）。
  - キャスト削除: 確認モーダル後に削除。
- **データ**: 起動時に cast/db.json を読み込み。変更時は write_cast_db_json で保存。

### 4.8 NGユーザー管理（ngManagement）

- **機能**: キャストを選択し、そのキャストが接客しないユーザー（NG）を追加・削除。マッチング時に反映（除外モード or 警告モードは設定で選択）。
- **データ**: キャストの ng_users 配列。cast/db.json に含まれる。

### 4.9 設定（settings）

- **機能**: テーマ切替、NG判定基準（ユーザー名のみ/アカウントIDのみ/どちらか）、マッチング時の挙動（警告/除外）、要注意人物の閾値・手動登録、NG例外の登録。localStorage で永続化。

### 4.10 デバッグ（debug）

- **表示条件**: 開発時（`import.meta.env.DEV`）のみサイドバーに表示。本番ビルドではスタブに置き換えられバンドルに含まれない。
- **機能**: LocalAppData 内の CosmoArtsStore 配下のフォルダ構造表示、cast/db.json の Oracle 風テーブル表示、簡易SQL風クエリでフィルタ表示。

---

## 5. データ仕様

### 5.1 応募データ（CSV取り込み）

- **取り込み元**: ユーザーが選択したCSVファイル。基本テンプレートまたはカスタム列割り当て。
- **必須**: ユーザー名またはアカウントID（X ID）のいずれか。希望キャストはオプション（1〜3列またはカンマ区切り1列）。

### 5.2 キャスト・NG（ローカルJSON）

- **保存先**: `%LOCALAPPDATA%\CosmoArtsStore\cast\db.json`
- **形式**: `{ "casts": [ { "name": "キャスト名", "is_present": true/false, "ng_users": ["ユーザー名", ...] } ] }`
- **読込**: 起動時に read_cast_db_json で読み込み。保存時は write_cast_db_json。

### 5.3 エクスポートCSV

- **抽選結果**: 列は timestamp, name, x_id, first_flag, 希望1〜3, 意気込み, is_pair_ticket 等。
- **マッチング結果**: テーブル別 or ユーザー別のマッチング表＋キャスト別接客リストを同一CSVに。ファイル名は `マッチング結果_YYYYMMDD_HHMMSS.csv`。

---

## 6. 非機能要件（要約）

- **認証**: なし（完全ローカル単体利用）。
- **外部連携**: なし。Google Sheets API 等は使用しない。
- **データ保持**:
  - 応募者一覧: メモリ＋セッション（localStorage）。リロードで再取り込みが必要。
  - キャスト・NG: LocalAppData の db.json に永続化。起動時に自動読込。
  - 当選者・抽選条件・表示ページ・設定: localStorage のセッションで同一端末・同一ブラウザではリロード後も復元可能。「セッションをクリア」でクリア。

---

## 7. 実装方式・使用技術

### 7.1 フレームワーク・言語

| 項目 | 使用技術 |
|------|----------|
| デスクトップ | Tauri 2 |
| UI | React, TypeScript |
| ビルド | Vite |
| スタイル | カスタム CSS（common.css, layout.css）。Discord 風カラートークン使用。 |
| アイコン | lucide-react |

### 7.2 フォルダ構成（フロント）

- **layout/**: AppContainer（ルーティング・サイドバー・ページ切替）。
- **features/**: 機能単位。guide, import, db, cast, ng-user, lottery, matching, settings。matching は logics, types, stores を内包。auth は削除済み（未使用）。
- **components/**: 共通UI（ErrorBoundary, HeaderLogo, ConfirmModal, AppSelect, ThemeSelector, DiscordTable）。
- **common/**: 型・定数・ユーティリティ（copy, config, themes, types/entities, sheetColumns, downloadCsv, sheetParsers 等）。
- **stores/**: AppContext（Repository, ページ状態, マッチング設定等）。
- **debug/**: デバッグ用（本番ビルド時は vite プラグインでスタブに置換）。

### 7.3 Tauri コマンド

- **get_app_data_dir**: LocalAppData の CosmoArtsStore パスを返す。
- **ensure_app_dirs**: cast, import, app, backup フォルダを生成。
- **read_cast_db_json / write_cast_db_json**: キャストJSONの読書。
- **list_app_data_structure**: デバッグ用。CosmoArtsStore 配下のディレクトリ木を返す。
- **read_file**: ユーザーが選択したファイルの内容を読み込み（CSV取り込み等で利用可能）。

### 7.4 状態管理

- **AppContext**: 表示ページ、Repository（応募者・キャストのメモリ保持）、当選者、マッチング形式・ローテーション数・総テーブル数等、テーマ、マッチング設定（NG判定基準・要注意・NG例外）。セッションは localStorage に永続化。

### 7.5 抽選・マッチングロジック

- **抽選**: クライアント側で応募者リストをシャッフルし、当選人数分を取得。
- **マッチング**: features/matching/logics の MatchingService。M001〜M006 で完全分離。詳細は `docs/matching-system-specification.md` を参照。

### 7.6 CSV ダウンロード

- **common/downloadCsv.ts**: 二次元配列を BOM 付き CSV にし、Blob からダウンロードリンクで保存。API 不要。

---

## 8. 制約・既知の課題と今後の検討事項

- **データ永続性**: 応募者一覧はメモリ＋セッションのため、リロード後は再度CSV取り込みが必要。キャストは db.json で永続化済み。
- **マッチング「解なし」**: 条件が厳しい場合に解が存在しない場合あり。フォールバック（希望外割当許容等）はロジック内で一部対応。
- **デバッグタブ**: 開発時のみ表示。本番ビルドではコードが含まれないよう vite-plugin-exclude-debug でスタブ化。

---

## 9. 改訂履歴

| 版 | 日付 | 内容 |
|----|------|------|
| 1.0 | （初版） | Web/Next.js/Sheets/認証を前提とした仕様。 |
| 2.0 | 2026年2月 | **全面改訂**。Stargazer として Tauri デスクトップ・完全ローカル・CSV エクスポートに合わせて仕様を更新。認証・Google Sheets 削除。画面一覧・データ仕様・実装方式を現行実装に合わせて記載。 |

---

**補足**  
- マッチングロジックの詳細（NGユーザー・要注意人物・M001〜M006）は `matching-system-specification.md` を参照してください。
- 本仕様書は、開発・保守時の「何がどこにあるか」の共通認識として利用できます。
