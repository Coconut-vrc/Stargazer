# 抽選結果TSVインポート機能

## 概要

抽選結果TSVファイルをインポートして、当選者を直接設定できる機能を実装しました。

## 実装内容

### 1. バリデーション機能 (`lotteryImport.ts`)

#### ヘッダー検証
- 期待されるヘッダー形式:
  ```
  timestamp	name	x_id	first_flag	希望1	希望2	希望3	意気込み	is_pair_ticket
  ```
- 列数チェック（9列必須）
- 各列名の完全一致チェック

#### データ行検証
- 列数チェック
- 必須フィールドチェック:
  - `name`: 空でないこと
  - `x_id`: 空でないこと
- `is_pair_ticket`: `0` または `1` であること（警告）

#### パース機能
- TSV行を `UserBean` に変換
- 空フィールドは適切にデフォルト値を設定
- `casts` 配列は空でない希望キャストのみ追加

### 2. UI実装 (`LotteryPage.tsx`)

#### インポートボタン
- 「抽選結果TSVをインポート」ボタンを追加
- 「抽選を開始する」ボタンの上に配置

#### ファイル選択
- 隠しファイル入力（`<input type="file">`）
- `.tsv` ファイルのみ受け付け
- `useRef` でファイル入力を参照

#### インポート処理フロー
1. ユーザーがボタンをクリック
2. ファイル選択ダイアログを表示
3. ファイルを選択
4. `FileReader` でUTF-8として読み込み
5. `parseLotteryResultTsv()` でバリデーション＆パース
6. エラーがあればアラート表示
7. 成功したら `setCurrentWinners()` で当選者を設定
8. 抽選結果ページ（`lottery`）に遷移

### 3. エラーハンドリング

#### バリデーションエラー
- ヘッダー形式不正
- 列数不一致
- 必須フィールド欠損

エラーメッセージ例:
```
抽選結果TSVの形式が不正です:

列1のヘッダーが不正です。期待: "timestamp", 実際: "time"
行3: 名前が空です
行5: X IDが空です
```

#### 警告
- `is_pair_ticket` の値が `0` または `1` 以外

警告メッセージ例:
```
15名の当選者をインポートしました

警告:
行7: is_pair_ticketの値が不正です（"true"）。0または1である必要があります
```

## 使用方法

### 1. 抽選結果TSVをエクスポート
1. 抽選を実行
2. マッチング画面で「TSVエクスポート」
3. ファイルが保存される

### 2. TSVファイルを編集（必要に応じて）
- 当選者の追加・削除
- 希望キャストの変更
- **注意**: ヘッダー行は変更しないこと

### 3. TSVファイルをインポート
1. 抽選条件画面で「抽選結果TSVをインポート」をクリック
2. TSVファイルを選択
3. バリデーションが成功すれば当選者が設定される
4. 自動的に抽選結果ページに遷移

## TSV形式仕様

### ヘッダー行（必須）
```tsv
timestamp	name	x_id	first_flag	希望1	希望2	希望3	意気込み	is_pair_ticket
```

### データ行
```tsv
2024-01-01 12:00:00	山田太郎	yamada_taro	初回	キャストA	キャストB	キャストC	よろしくお願いします	0
2024-01-01 12:01:00	佐藤花子	sato_hanako		キャストB	キャストA		楽しみです	1
```

### フィールド説明

| 列番号 | フィールド名 | 必須 | 説明 |
|--------|-------------|------|------|
| 1 | `timestamp` | × | タイムスタンプ |
| 2 | `name` | ○ | ユーザー名 |
| 3 | `x_id` | ○ | X (Twitter) ID |
| 4 | `first_flag` | × | 初回フラグ |
| 5 | `希望1` | × | 第1希望キャスト |
| 6 | `希望2` | × | 第2希望キャスト |
| 7 | `希望3` | × | 第3希望キャスト |
| 8 | `意気込み` | × | メモ・意気込み |
| 9 | `is_pair_ticket` | × | ペアチケット（`0` or `1`） |

## バリデーションルール

### 厳格なチェック（エラー）
1. **ヘッダー行の完全一致**
   - 列数が9列であること
   - 各列名が期待値と完全に一致すること

2. **データ行の列数**
   - すべての行が9列であること

3. **必須フィールド**
   - `name` が空でないこと
   - `x_id` が空でないこと

### 緩いチェック（警告）
1. **`is_pair_ticket` の値**
   - `0`, `1`, または空であること
   - それ以外の値は警告を表示するが、インポートは継続

## 実装ファイル

### 新規作成
- `desktop/src/common/lotteryImport.ts`: バリデーション＆パース機能

### 変更
- `desktop/src/features/lottery/LotteryPage.tsx`: UI＆インポートロジック

## テストケース

### 正常系
- [ ] 正しい形式のTSVをインポートできる
- [ ] 空フィールドを含むTSVをインポートできる
- [ ] 希望キャストが1つだけのTSVをインポートできる
- [ ] 警告があってもインポートが成功する

### 異常系
- [ ] ヘッダー行が不正なTSVはエラー
- [ ] 列数が不一致なTSVはエラー
- [ ] 必須フィールドが空の行はエラー
- [ ] 空ファイルはエラー

## 今後の拡張案

1. **ドラッグ＆ドロップ対応**
   - ファイル選択ダイアログだけでなく、D&Dでもインポート可能に

2. **プレビュー機能**
   - インポート前に内容をプレビュー表示
   - 確認後にインポート実行

3. **部分インポート**
   - エラー行をスキップして、正常な行のみインポート

4. **エクスポート形式の選択**
   - CSV形式にも対応
   - Excel形式（.xlsx）にも対応

## まとめ

抽選結果TSVインポート機能により、以下が可能になりました:

✅ **再利用性**: 過去の抽選結果を再利用  
✅ **編集可能**: TSVファイルを編集して当選者を調整  
✅ **バリデーション**: 厳格なチェックで不正なデータを防止  
✅ **エラー表示**: 詳細なエラーメッセージで問題箇所を特定  
✅ **ユーザビリティ**: シンプルなボタン操作でインポート

この機能により、抽選結果の管理がより柔軟になり、手動での調整も容易になりました。
