# chocomelapp 機能設計書

> 内部メモ: 2026-02-10 デプロイ用の軽微なコメント更新。

## 画面一覧

| 画面名 | 画面ID | 説明 | アクセス条件 |
|--------|--------|------|--------------|
| ログイン画面 | LOGIN | パスワード認証によるログイン | 未ログイン時 |
| ガイド | GUIDE | 使い方・FAQ | ログイン後 |
| データ読取 | IMPORT | スプレッドシートURL設定・同期・3択インポート・既存結果取り込み | ログイン後 |
| DBデータ確認 | DB | 応募者名簿の一覧表示・確認 | ログイン後 |
| 抽選条件 | LOTTERY_CONDITION | 抽選条件の設定と抽選実行 | ログイン後 |
| 抽選結果 | LOTTERY | 抽選結果の確認とエクスポート | ログイン後 |
| マッチング結果 | MATCHING | マッチング結果の表示とエクスポート | ログイン後 |
| キャスト管理 | CAST | キャストの出席管理とNGユーザー管理 | ログイン後 |

---

## 1. ログイン画面（LOGIN）

### 画面説明
アプリケーションへのアクセスを制限するための認証画面です。パスワードを入力してログインします。

### 主要機能
- パスワード認証
- ログイン状態の維持（1週間）
- エラーメッセージの表示

### 入力項目
| 項目名 | 必須 | 説明 | 制約 |
|--------|------|------|------|
| パスワード | ○ | 管理用パスワード | 文字列 |

### 操作手順
1. パスワードを入力
2. 「ログイン」ボタンをクリック、またはEnterキーを押す
3. 認証成功後、自動的に「データ読取」画面に遷移

### 表示項目
- パスワード入力フィールド
- ログインボタン
- エラーメッセージ（認証失敗時）

### 注意事項
- パスワードは環境変数で管理されています
- ログイン後、1週間は自動的にログイン状態が維持されます
- 共有PCで使用する場合は、必ずログアウトしてください

### 画像欄
[ここにログイン画面のスクリーンショットを貼り付け]

---

## 2. データ読取（IMPORT）

### 画面説明
Googleスプレッドシートとの連携を設定する画面です。応募者名簿とキャストリストのURLを設定し、データを読み込みます。**「データを取り込む」**ボタン押下時、前回セッションの有無に応じて3択のインポート方法を選択できます。

### 主要機能
- 営業モードの選択（特別営業/通常営業）
- GoogleスプレッドシートURLの設定
- **インポート方法の3択**（セッションあり時のみモーダル表示）
- データの同期と読み込み
- 既存の抽選結果シートの検出とインポート（Step2）

### 入力項目
| 項目名 | 必須 | 説明 | 制約 |
|--------|------|------|------|
| 営業モード | ○ | 特別営業（完全事前抽選制）または通常営業 | 選択式 |
| 応募者名簿 URL | ○ | GoogleスプレッドシートのURL | URL形式 |
| キャストリスト URL | ○ | GoogleスプレッドシートのURL | URL形式 |

### 操作手順
1. 営業モードを選択
   - **特別営業（完全事前抽選制）**: 希望キャストは3つの別項目（E列、F列、G列）から読み込み
   - **通常営業**: 希望キャストは1項目（E列）のカンマ区切りから読み込み
2. 応募者名簿のURLを入力（コピー&ペースト推奨）
3. キャストリストのURLを入力（コピー&ペースト推奨）
4. **「データを取り込む」**ボタンをクリック
5. **セッションがない場合**（初回またはログアウト後）  
   → そのまま応募者・キャストの両方を読み込み、DBデータ確認画面へ遷移（既存抽選結果シートの選択モーダルは出さない）。
6. **セッションがある場合**（前回の利用が同じ端末・同じブラウザに残っている場合）  
   → **3択モーダル**が表示される。いずれかを選択して「OK」を押すと実行される。
   - **続きから**  
     キャストリストのみ再読み込みし、前回の抽選結果と設定を引き継ぐ。  
     ※ 選択可能なのは**セッションに抽選結果（当選者）が残っているときのみ**。残っていない場合は選択不可（「セッションに抽選結果が残っていないため選択できません」と表示）。
   - **新規抽選**  
     データをリセットし、応募者・キャストの両方を読み込む。既存の抽選結果シートがあってもStep2のモーダルは出さず、DBデータ確認画面へ。
   - **保存した抽選結果を読み取る**  
     データをリセットし、応募者・キャストを両方読み込んだあと、**Step2**に進む。同一モーダル内で「読み込み中…」表示ののち、過去抽選結果シートの一覧が表示される。読み込むシートとマッチング方式を選択して「このシートを取り込む」で当選者リストを復元し、抽選結果画面へ。  
     過去抽選結果シートが1枚もない場合は「過去抽選結果シートが存在しないため、現在の応募リストとキャストリストのみを読み込みました」と表示し、OKで閉じると新規抽選と同様の状態になる。
7. データ読み込み後、自動的に「DBデータ確認」画面に遷移（Step2で抽選結果を取り込んだ場合は抽選結果画面に遷移）

### 表示項目
- 営業モード選択ボタン
- URL入力フィールド（応募者名簿、キャストリスト）
- 「データを取り込む」ボタン
- 営業モードごとの説明文
- 3択モーダル（続きから / 新規抽選 / 保存した抽選結果を読み取る）、Step2（シート選択・マッチング方式）

### URL・セッションの保存について
- 入力したURLとセッション（当選者・設定・表示中画面など）は**ブラウザの localStorage** にのみ保存されます。
- **同一端末・同一ブラウザ**でしか参照できません（他端末・他ブラウザ・シークレットモードは別扱い）。サーバーには送信されません。
- 現在使用中のシートURLはセッション（`chocomelapp_session`）に含まれており、リロード時に復元されます。URL履歴（入力補完用）は別キー（`chocomelapp_user_url_history` / `chocomelapp_cast_url_history`）で最大1件ずつ保持します。
- ログアウト時はセッションが削除され、メモリ上のデータもクリアされます。

### 注意事項
- URLはGoogleスプレッドシートのURLをそのままコピー&ペーストしてください
- サービスアカウントのメールアドレスをスプレッドシートの共有設定に追加する必要があります
- 初回のみ設定が必要で、以降は自動的に読み込まれます

### 画像欄
[ここにデータ読取画面のスクリーンショットを貼り付け]

---

## 3. DBデータ確認（DB）

### 画面説明
読み込んだ応募者名簿のデータを一覧表示する画面です。ユーザー情報と希望キャストを確認できます。

### 主要機能
- 応募者名簿の一覧表示
- X IDからのユーザーページへの遷移
- 希望キャストの確認

### 入力項目
なし（表示のみ）

### 操作手順
1. 画面を開くと、自動的に応募者名簿が表示されます
2. X IDをクリックすると、外部サイト（X）への遷移確認モーダルが表示されます
3. 「OK」をクリックすると、新しいタブでXのユーザーページが開きます
4. 「抽選条件へ」ボタンをクリックすると、抽選条件画面に遷移します

### 表示項目
| 項目名 | 説明 |
|--------|------|
| 名前 | 応募者の名前 |
| X ID | X（旧Twitter）のID（クリックでユーザーページに遷移） |
| 希望1 | 第1希望のキャスト名 |
| 希望2 | 第2希望のキャスト名 |
| 希望3 | 第3希望のキャスト名 |
| 意気込み | 意気込み欄の内容 |

### 注意事項
- X IDをクリックすると、外部サイトへの遷移確認モーダルが表示されます
- 希望キャストが未入力の場合は「—」と表示されます
- データは「データ読取」画面で読み込んだ内容が表示されます

### 画像欄
[ここにDBデータ確認画面のスクリーンショットを貼り付け]

---

## 4. 抽選条件（LOTTERY_CONDITION）

### 画面説明
抽選の条件を設定し、抽選を実行する画面です。営業モード、当選人数、マッチング方式を選択できます。

### 主要機能
- 営業モードの選択
- 当選人数の設定
- 総テーブル数の設定（通常営業時のみ）
- マッチング方式の選択
- 抽選の実行

### 入力項目
| 項目名 | 必須 | 説明 | 制約 |
|--------|------|------|------|
| 営業モード | ○ | 特別営業（完全事前抽選制）または通常営業 | 選択式 |
| 当選人数 | ○ | 抽選で選ぶ人数 | 1以上の整数、出席キャスト数以下 |
| 総テーブル数 | △ | 用意済みテーブルの総数（通常営業時のみ） | 当選者数以上 |
| マッチング方式 | ○ | ランダムマッチングまたは循環方式マッチング | 選択式 |

### 操作手順
1. 営業モードを選択
   - **特別営業（完全事前抽選制）**: 当選人数 = 出席キャスト数
   - **通常営業**: 総テーブル数 ≥ 当選者数
2. 当選人数を入力
3. 通常営業の場合は、総テーブル数を入力
4. マッチング方式を選択
   - **ランダムマッチング（希望優先）**: 希望キャストを優先的に割り当てるランダムマッチング
   - **循環方式マッチング（ローテーション）**: 循環ローテーション＋重み付きランダム
5. 「抽選を開始する」ボタンをクリック
6. 出席者数と当選人数（または総テーブル数）が一致しない場合、確認モーダルが表示されます
7. 「OK」をクリックすると、抽選が実行され、「マッチング構成確認」画面に遷移します

### 表示項目
- 営業モード選択ボタン
- 当選人数入力フィールド
- 総テーブル数入力フィールド（通常営業時のみ）
- マッチング方式選択ボタン
- 抽選開始ボタン
- 確認モーダル（条件不一致時）
- エラーメッセージ（条件エラー時）

### 注意事項
- **特別営業**: 当選人数が出席キャスト数を超える場合はエラーになります
- **通常営業**: 総テーブル数が当選者数未満の場合はエラーになります
- 出席者数と設定値が一致しない場合、確認モーダルが表示されますが、実行は可能です
- マッチング方式は、後続のマッチング処理に影響します

### 画像欄
[ここに抽選条件画面のスクリーンショットを貼り付け]

---

## 5. マッチング構成確認（LOTTERY_RESULT）

### 画面説明
抽選結果を確認し、スプレッドシートにエクスポートする画面です。当選者と希望キャストを再度確認してから、マッチングに進みます。

### 主要機能
- 抽選結果の一覧表示
- 抽選結果のスプレッドシートへのエクスポート
- マッチング画面への遷移

### 入力項目
なし（表示のみ）

### 操作手順
1. 画面を開くと、自動的に抽選結果が表示されます
2. 当選者と希望キャストを確認します
3. 「抽選結果をシートに保存」ボタンをクリックすると、スプレッドシートに新しいシートとして保存されます
   - シート名: `抽選結果_YYYYMMDD_HHMMSS`
4. 「マッチング開始」ボタンをクリックすると、「マッチング結果」画面に遷移します

### 表示項目
| 項目名 | 説明 |
|--------|------|
| # | 連番 |
| ユーザー | 当選者の名前 |
| X ID | X（旧Twitter）のID |
| 希望1 | 第1希望のキャスト名 |
| 希望2 | 第2希望のキャスト名 |
| 希望3 | 第3希望のキャスト名 |
| 意気込み | 意気込み欄の内容 |

### 出力項目
スプレッドシートにエクスポートされる項目:
- timestamp, name, x_id, first_flag, 希望1, 希望2, 希望3, note, is_pair_ticket

### 注意事項
- 当選者がいない場合は、エクスポートとマッチング開始ができません
- エクスポートしたシートは、応募者名簿のスプレッドシート内に作成されます
- マッチングを開始する前に、必ず抽選結果をエクスポートすることを推奨します

### 画像欄
[ここにマッチング構成確認画面のスクリーンショットを貼り付け]

---

## 6. マッチング結果（MATCHING）

### 画面説明
マッチング結果を表示する画面です。ユーザー別とキャスト別の2つの視点で結果を確認できます。

### 主要機能
- ユーザー別マッチング結果の表示
- キャスト別マッチング結果の表示
- マッチング結果のスプレッドシートへのエクスポート

### 入力項目
なし（表示のみ）

### 操作手順
1. 画面を開くと、自動的にマッチング結果が計算・表示されます
2. 「ユーザー別マッチング結果」テーブルで、各ユーザーの各ローテーションでの割り当てを確認します
3. 「キャスト別マッチング」テーブルで、各キャストの各ローテーションでの接客ユーザーを確認します
4. 「マッチング結果をシートに保存」ボタンをクリックすると、スプレッドシートに新しいシートとして保存されます
   - シート名: `マッチング結果_YYYYMMDD_HHMMSS`

### 表示項目

#### ユーザー別マッチング結果
| 項目名 | 説明 |
|--------|------|
| 当選ユーザー | 当選者の名前とX ID |
| 1ローテ目 | 第1ローテーションで割り当てられたキャスト名と希望ランク |
| 2ローテ目 | 第2ローテーションで割り当てられたキャスト名と希望ランク |
| 3ローテ目 | 第3ローテーションで割り当てられたキャスト名と希望ランク（通常営業時のみ） |

#### キャスト別マッチング結果
| 項目名 | 説明 |
|--------|------|
| キャスト | キャスト名 |
| 1ローテ目 | 第1ローテーションで接客するユーザー名、X ID、希望ランク |
| 2ローテ目 | 第2ローテーションで接客するユーザー名、X ID、希望ランク |
| 3ローテ目 | 第3ローテーションで接客するユーザー名、X ID、希望ランク（通常営業時のみ） |

### 出力項目
スプレッドシートにエクスポートされる項目:

#### ユーザー別マッチング結果
- name, x_id, 1ローテ目_キャスト, 1ローテ目_ランク, 2ローテ目_キャスト, 2ローテ目_ランク, ...（3ローテ目は通常営業時のみ）

#### キャスト別接客リスト
- cast_name, 1ローテ目_ユーザー, 1ローテ目_XID, 1ローテ目_ランク, 2ローテ目_ユーザー, 2ローテ目_XID, 2ローテ目_ランク, ...（3ローテ目は通常営業時のみ）

### 注意事項
- マッチング結果は、抽選結果とマッチング方式に基づいて自動的に計算されます
- **特別営業**: 2ローテーション制
- **通常営業**: 3ローテーション制
- 希望ランクは以下のように表示されます:
  - 第1希望（金色バッジ）
  - 第2希望（銀色バッジ）
  - 第3希望（銅色バッジ）
  - 希望外（グレーバッジ）
- 未配置の場合は「未配置」と表示されます

### 画像欄
[ここにマッチング結果画面のスクリーンショットを貼り付け]

---

## 7. キャスト管理（CAST）

### 画面説明
キャストの出席管理とNGユーザー管理を行う画面です。キャストの追加・削除、出席状態の切り替え、NGユーザーの追加・削除ができます。

### 主要機能
- キャストの新規登録
- キャストの削除
- キャストの出席状態の切り替え
- NGユーザーの追加・削除
- 出席状況の表示

### 入力項目
| 項目名 | 必須 | 説明 | 制約 |
|--------|------|------|------|
| キャスト名 | ○ | 新規登録するキャスト名 | 文字列、重複不可 |
| 対象キャスト | ○ | NGユーザーを追加する対象のキャスト | 選択式 |
| NGユーザー名 | ○ | NGユーザーの名前 | 文字列 |

### 操作手順

#### キャストの新規登録
1. 「キャストを新規登録」欄にキャスト名を入力
2. 「登録」ボタンをクリック
3. スプレッドシートに自動的に追加されます

#### キャストの削除
1. 削除したいキャストのカードの「削除」ボタンをクリック
2. 確認モーダルで「OK」をクリック
3. スプレッドシートから削除されます

#### 出席状態の切り替え
1. キャストカードの「出席中」/「欠席」ボタンをクリック
2. 状態が切り替わり、スプレッドシートに自動的に反映されます

#### NGユーザーの追加
1. 「対象キャスト」ドロップダウンからキャストを選択
2. 「NGユーザーを追加」欄にユーザー名を入力
3. 「追加」ボタンをクリック、またはEnterキーを押す
4. NGユーザーリストに追加され、スプレッドシートに自動的に反映されます

#### NGユーザーの削除
1. NGユーザーチップの「×」をクリック
2. NGユーザーリストから削除され、スプレッドシートに自動的に反映されます

### 表示項目
- 出席状況カード（出席数/総数）
- キャスト新規登録フォーム
- NGユーザー登録フォーム
- キャストカード一覧
  - キャスト名
  - 出席状態インジケーター（緑/グレー）
  - 出席/欠席ボタン
  - NGユーザーリスト
  - 削除ボタン

### 注意事項
- キャスト名は重複できません
- 出席状態の変更は、スプレッドシートに自動的に反映されます
- NGユーザーの追加・削除も、スプレッドシートに自動的に反映されます
- NGユーザーは、マッチング時にそのキャストに割り当てられません
- キャストを削除すると、そのキャストのNGユーザー情報も削除されます

### 画像欄
[ここにキャスト管理画面のスクリーンショットを貼り付け]

---

## 共通機能

### サイドバー
- 各画面へのナビゲーション
- テーマ切り替え（ダーク/ライト/しょこめる）
- ログアウト機能

### モーダル
- 確認モーダル: 操作の確認を求める
- アラートモーダル: エラーメッセージや通知を表示

### エクスポート機能
- すべてのエクスポートは、応募者名簿のスプレッドシート内に新しいシートとして作成されます
- シート名は自動生成されます（`抽選結果_YYYYMMDD_HHMMSS`、`マッチング結果_YYYYMMDD_HHMMSS`）

---

## データフロー

```
1. ログイン
   ↓
2. データ読取（Googleスプレッドシートからデータを読み込み）
   ↓
3. DBデータ確認（読み込んだデータを確認）
   ↓
4. キャスト管理（必要に応じてキャストの出席状態を設定）
   ↓
5. 抽選条件（抽選条件を設定して抽選を実行）
   ↓
6. マッチング構成確認（抽選結果を確認・エクスポート）
   ↓
7. マッチング結果（マッチング結果を確認・エクスポート）
```

---

## 営業モードの違い

| 項目 | 特別営業（完全事前抽選制） | 通常営業 |
|------|---------------------------|----------|
| 希望キャストの読み込み | E列、F列、G列からそれぞれ1つずつ | E列にカンマ区切りで1~3名 |
| 当選人数の制約 | 当選人数 ≤ 出席キャスト数 | 総テーブル数 ≥ 当選者数 |
| ローテーション数 | 2ローテーション | 3ローテーション |
| マッチングの優先順位 | 希望キャストを優先的に割り当て | 希望キャストをできる限りかなえ、かなわない分は希望外として割り当て |

---

## マッチング方式の違い

| 項目 | ランダムマッチング（希望優先） | 循環方式マッチング（ローテーション） |
|------|------------------------------|-----------------------------------|
| アルゴリズム | 希望キャストを優先的に割り当てるランダムマッチング | 循環ローテーション＋重み付きランダム |
| 特徴 | 希望キャストが優先される | 全員が公平にローテーションする |
| 適用場面 | 希望をできる限り叶えたい場合 | 公平性を重視する場合 |

---

## アプリの根幹ロジック

本節では、画面の背後で動く**コアロジック**（永続化・インポート・シートパース・抽選・マッチング・データの流れ）を整理します。仕様変更や不具合調査の際の参照として利用してください。

### 1. セッション・永続化

- **保存先**: すべて**ブラウザの localStorage**（同一オリジン・同一ブラウザプロファイル内）。サーバーにはセッション内容を送らない。
- **キー**（`app/common/config.ts` の `STORAGE_KEYS`）:
  - **SESSION** (`chocomelapp_session`): 当選者リスト（winners）、総テーブル数、営業モード、マッチング方式、表示中画面（activePage）、**応募者名簿URL・キャストリストURL**を JSON で1件保存。状態が変わるたびに上書き保存される。
  - **USER_URL_HISTORY** / **CAST_URL_HISTORY**: 入力補完用のURL履歴（配列）。最大件数は `URL_HISTORY_MAX`（現在1件）。
- **復元**: アプリ起動時（AppContext 初期化）に `getInitialSession()` が SESSION を読み、`currentWinners`・`totalTables`・`businessMode`・`matchingMode`・`activePage` を React の state に復元。`userSheetUrl` / `castSheetUrl` は Repository にセットされ、インポート画面の入力欄初期値や他画面の参照元になる。
- **クリア**: ログアウト時・未認証判定時に `clearSessionData()` が呼ばれ、Repository のリセット・`currentWinners` のクリア・localStorage の SESSION 削除が行われる。「新規抽選」「保存した抽選結果を読み取る」選択時も、実行前に同様のリセットが行われる。

### 2. インポートフロー（3択とStep2）

- **入口**: データ読取画面で「データを取り込む」押下。その時点で **SESSION の有無** を判定する。
- **セッションなし**: `loadData(userUrl, castUrl, { resetBefore: true })` をそのまま実行。応募者シート・キャストシートを取得し、Repository に保存して DB 画面へ。既存の抽選結果シートがあっても、この経路では**Step2（シート選択モーダル）は出さない**。
- **セッションあり**: 同じモーダル内で**3択**を表示。ユーザーが1つ選んで「OK」を押すと、次のいずれかが実行される。
  - **続きから**: セッションは触らず、**キャストシートのみ**再取得して `repository.saveCasts` と URL を更新。DB 画面へ。Step2 は出さない。選択可能条件は **セッションに抽選結果（当選者）が残っていること**（`currentWinners.length > 0`）。残っていない場合はボタン非活性＋「セッションに抽選結果が残っていないため選択できません」を表示。
  - **新規抽選**: `clearSessionData()` 相当のリセットののち、`loadData(..., { resetBefore: true })` で応募者・キャスト両方を読込。Step2 は出さない。
  - **保存した抽選結果を読み取る**: リセットののち `loadData` で応募者・キャストを読込。続けて同一ブック内のシート一覧を取得し、`抽選結果_` で始まるシート名を抽出。1件以上あればモーダルを **Step2** に切り替え（スライド表現）。ユーザーがシートとマッチング方式を選び「このシートを取り込む」で、そのシートの行を当選者として読み込み、抽選結果画面へ。該当シートが0件の場合は「過去抽選結果シートが存在しないため…」と表示し、OK で閉じると新規抽選と同様の状態になる。
- **共通**: 応募者シートの列数は営業モードに合わせて検証する（通常7列・特別9列）。不足行がある場合はエラーモーダルで通知し、読込は行わない。

### 3. シートパース（行データ → エンティティ）

- **責務**: `app/common/sheetParsers.ts` に集約。応募者シート・抽選結果シート・キャストシートの「行」を、アプリ内の型（UserBean / CastBean）に変換する。
- **希望キャストのパース**（`parseCastsFromRow`）:
  - **特別営業**: E列・F列・G列をそれぞれ1つずつ文字列として取得（空は除外）。常に長さ3以下の配列として返し、不足分は空文字で埋めて3要素に揃える。
  - **通常営業**: E列を1つの文字列として取得し、カンマ区切りで分割。前後空白トリム・重複除去・最大3件に制限したうえで、同様に3要素に揃える。
- **応募者／抽選結果の1行 → UserBean**（`mapRowToUserBean`）: 列インデックスは `USER_SHEET` と営業モード別の `USER_SHEET_BY_MODE`（`app/common/sheetColumns.ts`）で定義。タイムスタンプ・名前・X ID・先着フラグ・希望キャスト（上記パース）・意気込み・ペアチケットフラグを詰め、`raw_extra` は空配列。抽選結果シートの行も同じ形式で読むため、同一関数で変換する。
- **キャストシートの行 → CastBean[]**（`parseCastSheetRows`）: 各行から名前・出席フラグ（'1' なら true）・NGユーザー（カンマ区切り）を取得。名前が空の行は除外する。
- 応募者シートの**列数チェック**は AppContainer の `loadData` 内で実施。必要列数未満の行がある場合はエラーメッセージを出し、パースには進まない。

### 4. 抽選ロジック

- **実行タイミング**: 抽選条件画面で「抽選を開始する」押下後、条件（当選者数・総テーブル数・出席キャスト数）をチェックしてから、応募者リスト（Repository）から**無作為に当選者数を抽出**する。
- **制約**:
  - **特別営業**: 当選人数は出席キャスト数以下。超える場合はエラーメッセージを表示し抽選は実行しない。
  - **通常営業**: 総テーブル数 ≥ 当選者数。未満の場合は同様にエラー。総テーブル数はマッチングで「空テーブル含むスロット数」として使う。
- **結果の保持**: 抽選で得た当選者リスト（UserBean[]）は Context の `currentWinners` にセットされ、同時に SESSION に書き込まれるため、リロード後も復元される。抽選結果画面・マッチング画面はこの `currentWinners` を参照する。

### 5. マッチングロジック（MatchingService）

- **配置**: `app/features/matching/logics/matching_service.ts` の `MatchingService.runMatching`。入力は当選者リスト・全キャスト・マッチング方式・ローテーション数・総テーブル数（通常営業時のみ）。**出席中のキャスト**のみを対象とする。
- **NGの扱い**: 各キャストの `ng_users` にユーザーの名前または X ID が含まれる場合は、そのユーザーをそのキャストに割り当てない。
- **希望ランク**: ユーザーの `casts` 配列の何番目にそのキャストが入っているかで、第1〜第3希望（rank 1〜3）または希望外（0）を付与。マッチング結果の表示や重み付きランダムのスコアに利用する。
- **ランダムマッチング（希望優先）**:
  - ローテーション（ラウンド）ごとに、**1キャストあたり1ユーザー**まで割り当て。各ラウンドでユーザー順をシャッフルし、まだ希望が1つも当たっていないユーザーを優先して処理。
  - 各ユーザーについて、第1〜第3希望のキャストのうち、NGでなく・まだそのユーザーに割り当てられておらず・そのラウンドで未使用のキャストを候補とし、**重み付きランダム**（第1希望 100、第2 70、第3 40、希望外 10）で1人選択。希望がすべて埋まっているか取れない場合は、NG でない残りキャストからランダムに1人（希望外として）割り当てる。
- **循環方式マッチング（ローテーション）**:
  - 「行（テーブル/ユーザー）ごとに、ローテーションが1つ進むごとにキャストの並びが1つずつずれる」モデル。`baseCasts` をシャッフルしたキャスト並びとし、オフセット `offset` を 0 〜 length-1 で試す。
  - 各 offset について、全ユーザー×全ローテーションで NG が1件もない組み合わせかどうかと、希望ランクの合計スコアを計算。有効な offset のみを候補とし、そのスコアで**重み付きランダム**して offset を1つ選ぶ。選んだ offset で「行 i・ローテ r」のキャストを `baseCasts[(offset + i - r + L) % L]` で決定。
  - **通常営業で総テーブル数指定時**: スロット数 = 総テーブル数。当選者数より多い分は空テーブル（user: null）として扱い、同じ循環ルールでキャストだけ割り当てる。返却値に `tableSlots` が含まれ、マッチング画面の「テーブル別」表示に使う。
- **ローテーション数**: 特別営業は2、通常営業は3。`MatchingService.runMatching` の引数 `rotationCount` で渡す。

### 6. データの流れ（Repository と Context）

- **Repository**（シングルトン）: 応募者リスト（users）・キャストリスト（casts）・応募者名簿URL・キャストURL をメモリ上で保持。シートの取得・パース後に `saveApplyUsers` / `saveCasts` / `setUserSheetUrl` / `setCastSheetUrl` で更新。ログアウト・リセット時は `resetAll()` でクリア。**永続化は行わず**、セッション復元時に URL だけ Repository に再設定する。
- **Context（AppContext）**: 画面状態（activePage）、当選者（currentWinners）、マッチング方式・総テーブル数・営業モード・テーマなど、UI とフローに必要な state を保持。`currentWinners` と設定類・URL は SESSION に保存され、リロード時に復元される。
- **画面との関係**: DB確認は Repository の応募者一覧を表示。抽選条件は Repository の応募者・キャストと Context の設定から抽選を実行し、結果を `currentWinners` にセット。抽選結果・マッチング画面は `currentWinners` と Repository のキャストを参照。キャスト管理は Repository のキャストを表示・更新し、出席・NG の変更をスプレッドシートに書き戻す。エクスポート（抽選結果シート・マッチング結果シート）は、応募者名簿のスプレッドシート（Repository の userSheetUrl）に新規シートとして作成する。
