# chocomelapp 機能設計書

## 画面一覧

| 画面名 | 画面ID | 説明 | アクセス条件 |
|--------|--------|------|--------------|
| ログイン画面 | LOGIN | パスワード認証によるログイン | 未ログイン時 |
| データ読取 | IMPORT | Googleスプレッドシートとの連携設定 | ログイン後 |
| DBデータ確認 | DB | 応募者名簿の一覧表示・確認 | ログイン後 |
| 抽選条件 | LOTTERY | 抽選条件の設定と抽選実行 | ログイン後 |
| マッチング構成確認 | LOTTERY_RESULT | 抽選結果の確認とエクスポート | ログイン後 |
| マッチング結果 | MATCHING | マッチング結果の表示とエクスポート | ログイン後 |
| キャスト管理 | CAST | キャストの出席管理とNGユーザー管理 | ログイン後 |

---

## 1. ログイン画面（LOGIN）

### 画面説明
アプリケーションへのアクセスを制限するための認証画面です。パスワードを入力してログインします。

### 主要機能
- パスワード認証
- ログイン状態の維持（1週間）
- エラーメッセージの表示

### 入力項目
| 項目名 | 必須 | 説明 | 制約 |
|--------|------|------|------|
| パスワード | ○ | 管理用パスワード | 文字列 |

### 操作手順
1. パスワードを入力
2. 「ログイン」ボタンをクリック、またはEnterキーを押す
3. 認証成功後、自動的に「データ読取」画面に遷移

### 表示項目
- パスワード入力フィールド
- ログインボタン
- エラーメッセージ（認証失敗時）

### 注意事項
- パスワードは環境変数で管理されています
- ログイン後、1週間は自動的にログイン状態が維持されます
- 共有PCで使用する場合は、必ずログアウトしてください

### 画像欄
[ここにログイン画面のスクリーンショットを貼り付け]

---

## 2. データ読取（IMPORT）

### 画面説明
Googleスプレッドシートとの連携を設定する画面です。応募者名簿とキャストリストのURLを設定し、データを読み込みます。

### 主要機能
- 営業モードの選択（特殊営業/通常営業）
- GoogleスプレッドシートURLの設定
- データの同期と読み込み
- 既存の抽選結果シートの検出とインポート

### 入力項目
| 項目名 | 必須 | 説明 | 制約 |
|--------|------|------|------|
| 営業モード | ○ | 特殊営業（完全リクイン制）または通常営業 | 選択式 |
| 応募者名簿 URL | ○ | GoogleスプレッドシートのURL | URL形式 |
| キャストリスト URL | ○ | GoogleスプレッドシートのURL | URL形式 |

### 操作手順
1. 営業モードを選択
   - **特殊営業（完全リクイン制）**: 希望キャストは3つの別項目（E列、F列、G列）から読み込み
   - **通常営業**: 希望キャストは1項目（E列）のカンマ区切りから読み込み
2. 応募者名簿のURLを入力（コピー&ペースト推奨）
3. キャストリストのURLを入力（コピー&ペースト推奨）
4. 「保存して同期を開始」ボタンをクリック
5. データ読み込み後、自動的に「DBデータ確認」画面に遷移
6. 既存の抽選結果シートがある場合、モーダルが表示される
   - 読み込むシートを選択
   - マッチング方式を選択（ランダム/循環方式）
   - 「OK」をクリックしてインポート

### 表示項目
- 営業モード選択ボタン
- URL入力フィールド（応募者名簿、キャストリスト）
- 保存ボタン
- 営業モードごとの説明文

### 注意事項
- URLはGoogleスプレッドシートのURLをそのままコピー&ペーストしてください
- サービスアカウントのメールアドレスをスプレッドシートの共有設定に追加する必要があります
- 初回のみ設定が必要で、以降は自動的に読み込まれます

### 画像欄
[ここにデータ読取画面のスクリーンショットを貼り付け]

---

## 3. DBデータ確認（DB）

### 画面説明
読み込んだ応募者名簿のデータを一覧表示する画面です。ユーザー情報と希望キャストを確認できます。

### 主要機能
- 応募者名簿の一覧表示
- X IDからのユーザーページへの遷移
- 希望キャストの確認

### 入力項目
なし（表示のみ）

### 操作手順
1. 画面を開くと、自動的に応募者名簿が表示されます
2. X IDをクリックすると、外部サイト（X）への遷移確認モーダルが表示されます
3. 「OK」をクリックすると、新しいタブでXのユーザーページが開きます
4. 「抽選条件へ」ボタンをクリックすると、抽選条件画面に遷移します

### 表示項目
| 項目名 | 説明 |
|--------|------|
| 名前 | 応募者の名前 |
| X ID | X（旧Twitter）のID（クリックでユーザーページに遷移） |
| 希望1 | 第1希望のキャスト名 |
| 希望2 | 第2希望のキャスト名 |
| 希望3 | 第3希望のキャスト名 |
| 備考 | 備考欄の内容 |

### 注意事項
- X IDをクリックすると、外部サイトへの遷移確認モーダルが表示されます
- 希望キャストが未入力の場合は「—」と表示されます
- データは「データ読取」画面で読み込んだ内容が表示されます

### 画像欄
[ここにDBデータ確認画面のスクリーンショットを貼り付け]

---

## 4. 抽選条件（LOTTERY）

### 画面説明
抽選の条件を設定し、抽選を実行する画面です。営業モード、当選人数、マッチング方式を選択できます。

### 主要機能
- 営業モードの選択
- 当選人数の設定
- 総テーブル数の設定（通常営業時のみ）
- マッチング方式の選択
- 抽選の実行

### 入力項目
| 項目名 | 必須 | 説明 | 制約 |
|--------|------|------|------|
| 営業モード | ○ | 特殊営業（完全リクイン制）または通常営業 | 選択式 |
| 当選人数 | ○ | 抽選で選ぶ人数 | 1以上の整数、出席キャスト数以下 |
| 総テーブル数 | △ | 用意済みテーブルの総数（通常営業時のみ） | 当選者数以上 |
| マッチング方式 | ○ | ランダムマッチングまたは循環方式マッチング | 選択式 |

### 操作手順
1. 営業モードを選択
   - **特殊営業（完全リクイン制）**: 当選人数 = 出席キャスト数
   - **通常営業**: 総テーブル数 ≥ 当選者数
2. 当選人数を入力
3. 通常営業の場合は、総テーブル数を入力
4. マッチング方式を選択
   - **ランダムマッチング（希望優先）**: 希望キャストを優先的に割り当てるランダムマッチング
   - **循環方式マッチング（ローテーション）**: 循環ローテーション＋重み付きランダム
5. 「抽選を開始する」ボタンをクリック
6. 出席者数と当選人数（または総テーブル数）が一致しない場合、確認モーダルが表示されます
7. 「OK」をクリックすると、抽選が実行され、「マッチング構成確認」画面に遷移します

### 表示項目
- 営業モード選択ボタン
- 当選人数入力フィールド
- 総テーブル数入力フィールド（通常営業時のみ）
- マッチング方式選択ボタン
- 抽選開始ボタン
- 確認モーダル（条件不一致時）
- エラーメッセージ（条件エラー時）

### 注意事項
- **特殊営業**: 当選人数が出席キャスト数を超える場合はエラーになります
- **通常営業**: 総テーブル数が当選者数未満の場合はエラーになります
- 出席者数と設定値が一致しない場合、確認モーダルが表示されますが、実行は可能です
- マッチング方式は、後続のマッチング処理に影響します

### 画像欄
[ここに抽選条件画面のスクリーンショットを貼り付け]

---

## 5. マッチング構成確認（LOTTERY_RESULT）

### 画面説明
抽選結果を確認し、スプレッドシートにエクスポートする画面です。当選者と希望キャストを再度確認してから、マッチングに進みます。

### 主要機能
- 抽選結果の一覧表示
- 抽選結果のスプレッドシートへのエクスポート
- マッチング画面への遷移

### 入力項目
なし（表示のみ）

### 操作手順
1. 画面を開くと、自動的に抽選結果が表示されます
2. 当選者と希望キャストを確認します
3. 「抽選結果をシートに保存」ボタンをクリックすると、スプレッドシートに新しいシートとして保存されます
   - シート名: `抽選結果_YYYYMMDD_HHMMSS`
4. 「マッチング開始」ボタンをクリックすると、「マッチング結果」画面に遷移します

### 表示項目
| 項目名 | 説明 |
|--------|------|
| # | 連番 |
| ユーザー | 当選者の名前 |
| X ID | X（旧Twitter）のID |
| 希望1 | 第1希望のキャスト名 |
| 希望2 | 第2希望のキャスト名 |
| 希望3 | 第3希望のキャスト名 |
| 備考 | 備考欄の内容 |

### 出力項目
スプレッドシートにエクスポートされる項目:
- timestamp, name, x_id, first_flag, 希望1, 希望2, 希望3, note, is_pair_ticket

### 注意事項
- 当選者がいない場合は、エクスポートとマッチング開始ができません
- エクスポートしたシートは、応募者名簿のスプレッドシート内に作成されます
- マッチングを開始する前に、必ず抽選結果をエクスポートすることを推奨します

### 画像欄
[ここにマッチング構成確認画面のスクリーンショットを貼り付け]

---

## 6. マッチング結果（MATCHING）

### 画面説明
マッチング結果を表示する画面です。ユーザー別とキャスト別の2つの視点で結果を確認できます。

### 主要機能
- ユーザー別マッチング結果の表示
- キャスト別マッチング結果の表示
- マッチング結果のスプレッドシートへのエクスポート

### 入力項目
なし（表示のみ）

### 操作手順
1. 画面を開くと、自動的にマッチング結果が計算・表示されます
2. 「ユーザー別マッチング結果」テーブルで、各ユーザーの各ローテーションでの割り当てを確認します
3. 「キャスト別マッチング」テーブルで、各キャストの各ローテーションでの接客ユーザーを確認します
4. 「マッチング結果をシートに保存」ボタンをクリックすると、スプレッドシートに新しいシートとして保存されます
   - シート名: `マッチング結果_YYYYMMDD_HHMMSS`

### 表示項目

#### ユーザー別マッチング結果
| 項目名 | 説明 |
|--------|------|
| 当選ユーザー | 当選者の名前とX ID |
| 1ローテ目 | 第1ローテーションで割り当てられたキャスト名と希望ランク |
| 2ローテ目 | 第2ローテーションで割り当てられたキャスト名と希望ランク |
| 3ローテ目 | 第3ローテーションで割り当てられたキャスト名と希望ランク（通常営業時のみ） |

#### キャスト別マッチング結果
| 項目名 | 説明 |
|--------|------|
| キャスト | キャスト名 |
| 1ローテ目 | 第1ローテーションで接客するユーザー名、X ID、希望ランク |
| 2ローテ目 | 第2ローテーションで接客するユーザー名、X ID、希望ランク |
| 3ローテ目 | 第3ローテーションで接客するユーザー名、X ID、希望ランク（通常営業時のみ） |

### 出力項目
スプレッドシートにエクスポートされる項目:

#### ユーザー別マッチング結果
- name, x_id, 1ローテ目_キャスト, 1ローテ目_ランク, 2ローテ目_キャスト, 2ローテ目_ランク, ...（3ローテ目は通常営業時のみ）

#### キャスト別接客リスト
- cast_name, 1ローテ目_ユーザー, 1ローテ目_XID, 1ローテ目_ランク, 2ローテ目_ユーザー, 2ローテ目_XID, 2ローテ目_ランク, ...（3ローテ目は通常営業時のみ）

### 注意事項
- マッチング結果は、抽選結果とマッチング方式に基づいて自動的に計算されます
- **特殊営業**: 2ローテーション制
- **通常営業**: 3ローテーション制
- 希望ランクは以下のように表示されます:
  - 第1希望（金色バッジ）
  - 第2希望（銀色バッジ）
  - 第3希望（銅色バッジ）
  - 希望外（グレーバッジ）
- 未配置の場合は「未配置」と表示されます

### 画像欄
[ここにマッチング結果画面のスクリーンショットを貼り付け]

---

## 7. キャスト管理（CAST）

### 画面説明
キャストの出席管理とNGユーザー管理を行う画面です。キャストの追加・削除、出席状態の切り替え、NGユーザーの追加・削除ができます。

### 主要機能
- キャストの新規登録
- キャストの削除
- キャストの出席状態の切り替え
- NGユーザーの追加・削除
- 出席状況の表示

### 入力項目
| 項目名 | 必須 | 説明 | 制約 |
|--------|------|------|------|
| キャスト名 | ○ | 新規登録するキャスト名 | 文字列、重複不可 |
| 対象キャスト | ○ | NGユーザーを追加する対象のキャスト | 選択式 |
| NGユーザー名 | ○ | NGユーザーの名前 | 文字列 |

### 操作手順

#### キャストの新規登録
1. 「キャストを新規登録」欄にキャスト名を入力
2. 「登録」ボタンをクリック
3. スプレッドシートに自動的に追加されます

#### キャストの削除
1. 削除したいキャストのカードの「削除」ボタンをクリック
2. 確認モーダルで「OK」をクリック
3. スプレッドシートから削除されます

#### 出席状態の切り替え
1. キャストカードの「出席中」/「欠席」ボタンをクリック
2. 状態が切り替わり、スプレッドシートに自動的に反映されます

#### NGユーザーの追加
1. 「対象キャスト」ドロップダウンからキャストを選択
2. 「NGユーザーを追加」欄にユーザー名を入力
3. 「追加」ボタンをクリック、またはEnterキーを押す
4. NGユーザーリストに追加され、スプレッドシートに自動的に反映されます

#### NGユーザーの削除
1. NGユーザーチップの「×」をクリック
2. NGユーザーリストから削除され、スプレッドシートに自動的に反映されます

### 表示項目
- 出席状況カード（出席数/総数）
- キャスト新規登録フォーム
- NGユーザー登録フォーム
- キャストカード一覧
  - キャスト名
  - 出席状態インジケーター（緑/グレー）
  - 出席/欠席ボタン
  - NGユーザーリスト
  - 削除ボタン

### 注意事項
- キャスト名は重複できません
- 出席状態の変更は、スプレッドシートに自動的に反映されます
- NGユーザーの追加・削除も、スプレッドシートに自動的に反映されます
- NGユーザーは、マッチング時にそのキャストに割り当てられません
- キャストを削除すると、そのキャストのNGユーザー情報も削除されます

### 画像欄
[ここにキャスト管理画面のスクリーンショットを貼り付け]

---

## 共通機能

### サイドバー
- 各画面へのナビゲーション
- テーマ切り替え（ダーク/ライト/しょこめる）
- ログアウト機能

### モーダル
- 確認モーダル: 操作の確認を求める
- アラートモーダル: エラーメッセージや通知を表示

### エクスポート機能
- すべてのエクスポートは、応募者名簿のスプレッドシート内に新しいシートとして作成されます
- シート名は自動生成されます（`抽選結果_YYYYMMDD_HHMMSS`、`マッチング結果_YYYYMMDD_HHMMSS`）

---

## データフロー

```
1. ログイン
   ↓
2. データ読取（Googleスプレッドシートからデータを読み込み）
   ↓
3. DBデータ確認（読み込んだデータを確認）
   ↓
4. キャスト管理（必要に応じてキャストの出席状態を設定）
   ↓
5. 抽選条件（抽選条件を設定して抽選を実行）
   ↓
6. マッチング構成確認（抽選結果を確認・エクスポート）
   ↓
7. マッチング結果（マッチング結果を確認・エクスポート）
```

---

## 営業モードの違い

| 項目 | 特殊営業（完全リクイン制） | 通常営業 |
|------|---------------------------|----------|
| 希望キャストの読み込み | E列、F列、G列からそれぞれ1つずつ | E列にカンマ区切りで1~3名 |
| 当選人数の制約 | 当選人数 ≤ 出席キャスト数 | 総テーブル数 ≥ 当選者数 |
| ローテーション数 | 2ローテーション | 3ローテーション |
| マッチングの優先順位 | 希望キャストを優先的に割り当て | 希望キャストをできる限りかなえ、かなわない分は希望外として割り当て |

---

## マッチング方式の違い

| 項目 | ランダムマッチング（希望優先） | 循環方式マッチング（ローテーション） |
|------|------------------------------|-----------------------------------|
| アルゴリズム | 希望キャストを優先的に割り当てるランダムマッチング | 循環ローテーション＋重み付きランダム |
| 特徴 | 希望キャストが優先される | 全員が公平にローテーションする |
| 適用場面 | 希望をできる限り叶えたい場合 | 公平性を重視する場合 |
